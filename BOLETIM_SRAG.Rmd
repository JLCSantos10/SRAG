---
title: "Boletim epidemiolÃ³gico SRAG - SE"
author: ""  
date: "`r Sys.Date()`"
output:
  word_document:
    toc: true
    toc_depth: 2
    df_print: paged
  html_document:
    toc: true
    toc_depth: 2
    df_print: paged
    encoding: UTF-8
---

```{r setup-encoding, include=FALSE}
options(encoding = "UTF-8")
Sys.setlocale("LC_ALL", "Portuguese_Brazil.1252")  # Para Windows

dir.create("BOLETIM_SRAG_files/figure-docx", recursive = TRUE, showWarnings = FALSE)
```

```{r instalar pacotes, include=FALSE}
# Lista de pacotes CRAN
cran_packages <- c(
  "tidyverse", "lubridate", "plotly", "forecast", "EpiEstim", "DT", "officer",
  "rvg", "scales", "readxl", "purrr", "mem", "zoo", "stringi", "stringr","readxl","flextable","rmarkdown","slider","yaml","patchwork", "here"
)

# Instala apenas os pacotes que ainda nÃ£o estÃ£o instalados (usa utils:: para evitar masking)
to_install_cran <- cran_packages[!(cran_packages %in% utils::installed.packages()[, "Package"])]
if (base::length(to_install_cran) > 0) {
  utils::install.packages(to_install_cran)
}

```


```{r carregar pacotes, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
library(lubridate)
library(plotly)
library(forecast)
library(EpiEstim)
library(DT)
library(officer)
library(rvg)
library(scales)
library(readxl)
library(purrr)
library(patchwork)
library(zoo)
library(stringi)
library(stringr)
library(rmarkdown)
library(flextable)
library(slider)
library(yaml)
library(glue)
library(here)

# Ancorar o root do projeto a partir deste arquivo Rmd para caminhos portÃ¡teis
# Como o arquivo estÃ¡ em SRAG/, precisamos subir um nÃ­vel para acessar Bancos/
here::i_am("SRAG/BOLETIM_SRAG.Rmd")

# Alternativa: definir diretÃ³rio de trabalho explicitamente
# setwd(dirname(here::here()))
base::cat("DiretÃ³rio de trabalho atual:", base::getwd(), "\n")
base::cat("DiretÃ³rio do arquivo Rmd:", here::here(), "\n")

# Verifica se estamos no diretÃ³rio correto
if (!base::dir.exists("Bancos")) {
  base::cat("DiretÃ³rio 'Bancos' nÃ£o encontrado no diretÃ³rio atual. Tentando mudar para o diretÃ³rio correto...\n")
  if (base::dir.exists("SRAG/Bancos")) {
    base::setwd("SRAG")
    base::cat("Mudou para o diretÃ³rio SRAG\n")
  }
}
```

```{r padronizaÃ§Ã£o}
# ðŸ”  FunÃ§Ã£o para padronizar nomes (minÃºsculo, sem acento, sem espaÃ§os)
padronizar_nomes <- function(x) {

  x |>
    # Corrige encoding mal interpretado
    iconv(from = "", to = "UTF-8", sub = "") |>
    
    # Remove acentos
    stringi::stri_trans_general("Latin-ASCII") |>
    
    # MinÃºsculo
    stringr::str_to_lower() |>
    
    # Remove qualquer caractere que nÃ£o seja letra ou espaÃ§o
    stringr::str_replace_all("[^a-z ]", "") |>
    
    # Remove espaÃ§os duplicados
    stringr::str_squish()
}

# âœ… Padroniza colunas PCR_* para 0/1/NA (evita character vs logical no pivot_longer)
padroniza_pcr <- function(df, cols = dplyr::starts_with("PCR_")) {
  df %>%
    dplyr::mutate(
      dplyr::across({{ cols }}, ~{
        x_chr <- as.character(.x)
        x_chr <- stringr::str_to_upper(stringr::str_trim(x_chr))

        pos <- x_chr %in% c(
          "1", "TRUE", "T",
          "POSITIVO", "POS",
          "DETECTADO", "REAGENTE"
        )

        as.integer(dplyr::if_else(is.na(x_chr), NA, pos))
      })
    )
}

```


```{r Carregar bancos, include=FALSE}


base::cat("Carregando arquivo CSV SRAG...\n")

srag_min_path <- "Bancos/SRAG.csv"

if (!base::file.exists(srag_min_path)) {
  base::stop("Arquivo 'SRAG.csv' nÃ£o encontrado em ", srag_min_path)
}

srag <- readr::read_csv(srag_min_path, show_col_types = FALSE)

# ðŸ”¹ Renomeia ID_MN_RESI_pad para municipio
if ("ID_MN_RESI_pad" %in% names(srag)) {
  srag <- dplyr::rename(srag, municipio = ID_MN_RESI_pad)
} else {
  base::stop("Coluna 'ID_MN_RESI_pad' nÃ£o encontrada na base SRAG.")
}

# ðŸ”¹ Padroniza municÃ­pio
if ("municipio" %in% names(srag)) {
  srag <- dplyr::mutate(
    srag,
    municipio = padronizar_nomes(municipio)
  )
}

# ðŸ”¹ Cria coluna ano
if (!"DT_SIN_PRI" %in% names(srag)) {
  base::stop("Coluna 'DT_SIN_PRI' nÃ£o encontrada.")
}

if (!lubridate::is.Date(srag$DT_SIN_PRI) &&
    !lubridate::is.POSIXct(srag$DT_SIN_PRI)) {
  srag <- dplyr::mutate(
    srag,
    DT_SIN_PRI = lubridate::as_date(DT_SIN_PRI)
  )
}

srag <- dplyr::mutate(
  srag,
  ano = lubridate::year(DT_SIN_PRI)
)

# ðŸ”¹ Converte SE para inteiro
if ("SE" %in% names(srag)) {
  srag <- dplyr::mutate(srag, SE = as.integer(SE))
}

base::cat("SRAG carregado com", nrow(srag), "linhas.\n")

# ---------------------------------------------------------
# ðŸ“Œ Carregar parÃ¢metros externos
# ---------------------------------------------------------

params_candidates <- c(
  "params.yaml",
  here::here("params.yaml"),
  here::here("SRAG", "params.yaml")
)

params_path <- params_candidates[file.exists(params_candidates)][1]

if (is.na(params_path)) {
  stop("Arquivo 'params.yaml' nÃ£o encontrado.")
}

params_externos <- yaml::read_yaml(params_path)

filtro_ano <- params_externos$filtro_ano
ano_epidemico <- params_externos$ano_epidemico
ano_ref <- params_externos$ano_ref

estado_sel <- params_externos$estado
municipio_sel <- params_externos$municipio
usar_filtro_municipio <- params_externos$usar_filtro_municipio

if (is.null(estado_sel)) {
  stop("ParÃ¢metro 'estado' nÃ£o definido no params.yaml")
}

# ---------------------------------------------------------
# ðŸ“Œ Filtro por UF
# ---------------------------------------------------------

if ("SG_UF_NOT" %in% names(srag)) {

  srag <- srag |>
    dplyr::filter(SG_UF_NOT == estado_sel)

  base::cat("Filtro aplicado para UF:", estado_sel, "\n")
  base::cat("Casos apÃ³s filtro UF:", nrow(srag), "\n")

} else {
  warning("Coluna 'SG_UF_NOT' nÃ£o encontrada na base SRAG.")
}

# ---------------------------------------------------------
# ðŸ“Œ Filtro opcional por municÃ­pio
# ---------------------------------------------------------

if (isTRUE(usar_filtro_municipio) &&
    !is.null(municipio_sel)) {

  municipio_sel_pad <- padronizar_nomes(municipio_sel)

  srag <- srag |>
    dplyr::filter(municipio == municipio_sel_pad)

  base::cat("Filtro aplicado para municÃ­pio:", municipio_sel, "\n")
  base::cat("Casos apÃ³s filtro municÃ­pio:", nrow(srag), "\n")
}

# ---------------------------------------------------------
# ðŸ“Œ Carregar base populacional
# ---------------------------------------------------------

pop_path <- "Bancos/POP.csv"

if (!file.exists(pop_path)) {
  stop("Arquivo de populaÃ§Ã£o nÃ£o encontrado em ", pop_path)
}

pop <- read.csv(pop_path)

# ðŸ”¹ Padroniza municÃ­pio na base pop
if ("municipio" %in% names(pop)) {

  pop <- pop |>
    dplyr::mutate(
      municipio = padronizar_nomes(municipio),
      ano = as.numeric(ano)
    )

} else if ("id_municipio_nome" %in% names(pop)) {

  pop <- pop |>
    dplyr::rename(municipio = id_municipio_nome) |>
    dplyr::mutate(
      municipio = padronizar_nomes(municipio),
      ano = as.numeric(ano)
    )

} else {
  stop("Coluna de municÃ­pio nÃ£o encontrada na base POP.")
}

# ðŸ”¹ Filtro por UF na populaÃ§Ã£o
if ("sigla_uf" %in% names(pop)) {
  pop <- pop |>
    dplyr::filter(sigla_uf == estado_sel)
}

# ðŸ”¹ Filtro opcional por municÃ­pio na populaÃ§Ã£o
if (isTRUE(usar_filtro_municipio) &&
    !is.null(municipio_sel)) {

  municipio_sel_pad <- padronizar_nomes(municipio_sel)

  pop <- pop |>
    dplyr::filter(municipio == municipio_sel_pad)
}

base::cat("Base POP carregada com", nrow(pop), "linhas.\n")

# ---------------------------------------------------------
# ðŸ“Œ Pronto para cruzamento por:
# ano + municipio
# ---------------------------------------------------------



```

```{r mapeamento viral}
# Mapeamento dos nomes dos vÃ­rus
virus_map <- c(
  PCR_FLUASU = "Influenza A",
  PCR_FLUBLI = "Influenza B",
  PCR_SARS2  = "SARS-CoV-2",
  PCR_VSR    = "VÃ­rus Sincicial RespiratÃ³rio",
  PCR_PARA1  = "Parainfluenza 1",
  PCR_PARA2  = "Parainfluenza 2",
  PCR_PARA3  = "Parainfluenza 3",
  PCR_PARA4  = "Parainfluenza 4",
  PCR_ADENO  = "AdenovÃ­rus",
  PCR_METAP  = "MetapneumovÃ­rus",
  PCR_BOCA   = "BocavÃ­rus",
  PCR_RINO   = "RinovÃ­rus",
  PCR_OUTRO  = "Outro vÃ­rus respiratÃ³rio"
)


# Ordenar idades
niveis_idade  <- c("Menor de 2","2 a 10","11 a 19","20 a 29","30 a 39",
                     "40 a 49","50 a 59","60 a 69","70 a 79","80 e mais")

```

# VisÃ£o geral dos casos de SRAG na 

```{r casos por ano ,fig.width=9, fig.height=6, fig.cap = paste0("Figura 1 â€“ NÃºmero de casos por Semana EpidemiolÃ³gica e por ano, municipio -",min(filtro_ano), " a ", max(filtro_ano), ")"),results='asis',echo = FALSE}
      
df_1 <- srag %>%
  filter(ano >= min(filtro_ano), ano <= max(filtro_ano)) %>%
  group_by(ano, SE) %>%
  summarise(casos = n(), .groups = "drop") %>%
  complete(ano, SE = 1:53, fill = list(casos = 0)) %>%
  arrange(ano, SE) %>%
  mutate(
    semana_id = row_number(),  # eixo X contÃ­nuo sequencial
    ano_fator = factor(ano)
  ) |>
  filter(casos > 0)

ggplot(df_1, aes(x = semana_id, y = casos)) +
  geom_col(fill = "#1f77b4", width = 0.8) +
  geom_vline(
    data = df_1 %>% group_by(ano) %>% summarise(pos = max(semana_id)),
    aes(xintercept = pos),
    color = "gray50", linetype = "dotted"
  ) +
  scale_x_continuous(
    breaks = df_1 %>% group_by(ano) %>% summarise(pos = mean(semana_id)) %>% pull(pos),
    labels = levels(df_1$ano_fator),
    expand = c(0, 0)
  ) +
  labs(
    x = "Ano",
    y = "NÃºmero de Casos"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    axis.text.x = element_text(face = "bold", color = "black"),
    axis.title = element_text(face = "bold"),
    plot.title = element_text(face = "bold", color = "black")
  )

srag_filtrado <- srag %>% filter(ano == ano_ref)

```

```{r gerar texto grÃ¡fico 1, message=FALSE, warning=FALSE, echo = FALSE, results='asis'}
gerar_texto_ondas_srag <- function(df, anos) {
  # Verifica se tem exatamente dois anos para comparar
  if (length(anos) != 2) {
    stop("A funÃ§Ã£o requer exatamente dois anos para comparaÃ§Ã£o.")
  }
  
  df_picos <- df %>%
    filter(ano %in% anos) %>%
    group_by(ano,) %>%
    summarise(
      pico = max(casos, na.rm = TRUE),
      semana_pico = SE[which.max(casos)],
      .groups = "drop"
    ) %>%
    arrange(ano)
  
  ano_1 <- df_picos$ano[1]
  ano_2 <- df_picos$ano[2]
  
  texto <- glue::glue(
    "A distribuiÃ§Ã£o semanal dos casos de SRAG entre os anos de {ano_1} e {ano_2} evidencia um padrÃ£o sazonal recorrente, ",
    "com diferenÃ§as no momento e intensidade das ondas epidÃªmicas. ",
    "Em {ano_1}, o pico de notificaÃ§Ãµes ocorreu na semana epidemiolÃ³gica {df_picos$semana_pico[1]}, com {df_picos$pico[1]} casos. ",
    "JÃ¡ em {ano_2}, o pico foi registrado na semana {df_picos$semana_pico[2]}, totalizando {df_picos$pico[2]} casos. ",
    "Essas variaÃ§Ãµes reforÃ§am a importÃ¢ncia do monitoramento contÃ­nuo para identificaÃ§Ã£o antecipada de perÃ­odos crÃ­ticos, ",
    "especialmente nos meses com maior circulaÃ§Ã£o viral."
  )
  
  return(texto)
}

texto_ondas <- gerar_texto_ondas_srag(df_1, anos = filtro_ano)
texto_ondas

```

## IncidÃªncia SRAG Ano atual

```{r incidencia atual,fig.width=9, fig.height=6, fig.cap = paste0("Figura 2 â€“ NÃºmero de casos e incidÃªncia de SRAG por 100 mil habitantes por Semana EpidemiolÃ³gica, municipio -", ano_ref, "(n = ", nrow(srag_filtrado), ")")}

# Calcular incidÃªncia por semana epidemiolÃ³gica
srag_inc <- srag %>%
  filter(ano == ano_ref) %>%
  group_by(ano,SE, municipio) %>%
  summarise(
    casos = n(),
    .groups = "drop"
  ) %>%
  left_join(
    pop %>% select(ano, municipio, populacao),
    by = c("ano", "municipio" = "municipio")
  ) %>%
  filter(!is.na(populacao)) %>%
  group_by(SE) %>%
  summarise(
    casos = sum(casos),
    pop = sum(populacao),
    .groups = "drop"
  ) %>%
  mutate(
    inc = 100000 * casos / pop
  )


# Ordenar o eixo X corretamente (opcional)
srag_inc$SE <- factor(srag_inc$SE, levels = sort(unique(srag_inc$SE)))

# GrÃ¡fico de colunas
ggplot(srag_inc, aes(x = SE)) +
  geom_col(aes(y = casos), fill = "#1f77b4", width = 0.8) +  # colunas de casos
  geom_line(aes(y = inc * max(casos) / max(inc)),  # linha de incidÃªncia reescalada
            color = "red", size = 1.2, group = 1) +
  scale_y_continuous(
    name = "NÃºmero de casos",
    sec.axis = sec_axis(~ . * max(srag_inc$inc) / max(srag_inc$casos),
                        name = "IncidÃªncia por 100 mil hab.")
  ) +
  labs(
    x = "Semana EpidemiolÃ³gica",
  ) +
  theme_minimal(base_size = 13) +
  theme(
    axis.title.y = element_text(color = "black", face = "bold"),
    axis.title.y.right = element_text(color = "black", face = "bold"),
    axis.text.x = element_text(face = "bold", color = "black"),
    axis.title = element_text(face = "bold"),
    plot.title = element_text(face = "bold", color = "black")
  )
```


```{r texto para o resumo tÃ©cnico, echo = FALSE, results='asis'}
gerar_texto_resumo_srag <- function(ano, total_notificacoes, media_semanal, dp_semanal, total_obitos, taxa_letalidade) {
  
  variabilidade <- case_when(
    dp_semanal < 5 ~ "baixa variabilidade na distribuiÃ§Ã£o semanal",
    dp_semanal < 15 ~ "moderada variabilidade na distribuiÃ§Ã£o semanal",
    TRUE ~ "alta variabilidade na distribuiÃ§Ã£o semanal"
  )
  
  texto <- glue::glue(
    "Em {ano}, foram notificados {total_notificacoes} casos de SÃ­ndrome RespiratÃ³ria Aguda Grave (SRAG), ",
    "com uma mÃ©dia de {round(media_semanal, 1)} casos por semana epidemiolÃ³gica e um desvio padrÃ£o de {round(dp_semanal, 1)}, ",
    "indicando {variabilidade} dos casos ao longo do ano. ",
    if (total_obitos == 0) {
      "NÃ£o foram registrados Ã³bitos por SRAG no perÃ­odo, o que sugere um perfil de casos nÃ£o graves em 2025."
    } else if (total_obitos == 1) {
      "Observou-se um Ãºnico Ã³bito atribuÃ­do Ã  SRAG, resultando em uma taxa de letalidade de {round(taxa_letalidade, 1)}%,"
      "o que sugere um perfil de casos predominantemente nÃ£o graves no perÃ­odo avaliado."
    } else {
      "Foram registrados {total_obitos} Ã³bitos, com uma taxa de letalidade de {round(taxa_letalidade, 1)}%, "
      "refletindo a presenÃ§a de casos com maior gravidade."
    },
    " A baixa letalidade e o padrÃ£o de notificaÃ§Ãµes observados reforÃ§am a importÃ¢ncia da manutenÃ§Ã£o da vigilÃ¢ncia epidemiolÃ³gica ativa."
  )
  
  return(texto)
}
```

```{r resumo_situacao, echo=FALSE, results='asis'}
# Filtro do ano de interesse


# Total de notificaÃ§Ãµes
total_notificacoes <- nrow(srag_filtrado)

# Casos por semana
casos_semanal <- srag_filtrado %>%
  group_by(SE) %>%
  summarise(casos = n(), .groups = "drop")

# MÃ©dia e desvio padrÃ£o
media_casos <- mean(casos_semanal$casos, na.rm = TRUE)
dp_casos <- sd(casos_semanal$casos, na.rm = TRUE)

# Total de Ã³bitos
total_obitos <- sum(srag_filtrado$OBITOSRAG == "Sim", na.rm = TRUE)

# Taxa de letalidade (%)
taxa_letalidade <- (total_obitos / total_notificacoes) * 100

# Exibir resumo
tibble::tibble(
  `Total de notificaÃ§Ãµes` = total_notificacoes,
  `MÃ©dia semanal de casos` = round(media_casos, 1),
  `Desvio padrÃ£o semanal` = round(dp_casos, 1),
  `Total de Ã³bitos` = total_obitos,
  `Taxa de letalidade (%)` = round(taxa_letalidade, 1)
) %>%
  knitr::kable(caption = paste("Resumo da SituaÃ§Ã£o EpidemiolÃ³gica â€“", ano_ref))

texto_srag <- gerar_texto_resumo_srag(
  ano = ano_ref,
  total_notificacoes = total_notificacoes,
  media_semanal = media_casos,
  dp_semanal = dp_casos,
  total_obitos = total_obitos,
  taxa_letalidade = taxa_letalidade
)

texto_srag
```



## VÃ­rus detectados

```{r virus detectados, fig.width=9, fig.height=6,fig.height=6, fig.cap = paste0("Figura 3 â€“ ProporÃ§Ã£o de vÃ­rus detectados de SRAG, municipio -", ano_ref, "(n = ", sum(df_tot$casos), ")")}
cols_pcr <- names(virus_map)

df_tot <- srag %>%
  filter(ano == ano_ref) %>%
  select(all_of(cols_pcr)) %>%
  padroniza_pcr(cols = dplyr::everything()) %>%   # <- aqui
  pivot_longer(cols = everything(), names_to = "virus", values_to = "valor") %>%
  filter(valor == 1) %>%
  mutate(virus = virus_map[virus]) %>%
  count(virus, name = "casos") %>%
  mutate(
    percentual = casos / sum(casos) * 100,
    virus = fct_reorder(virus, casos)
  )


ggplot(df_tot, aes(x = virus, y = casos)) +
  geom_col(fill = "#4E79A7") +
  geom_text(
    aes(label = paste0(casos, " (", round(percentual, 1), "%)")),
    vjust = -0.3, size = 5
  ) +
  labs(
    x = "Tipo de VÃ­rus",
    y = "NÃºmero de Registros"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(face = "bold")
  )




```

```{r texto para tipos de vÃ­rus,  echo = FALSE, results='asis'}
gerar_texto_pcr_virus <- function(df_tot, ano) {
  df_ord <- df_tot %>% arrange(desc(casos))
  
  top1 <- df_ord$virus[1]
  top2 <- df_ord$virus[2]
  top3 <- df_ord$virus[3]
  
  pct1 <- round(df_ord$percentual[1], 1)
  pct2 <- round(df_ord$percentual[2], 1)
  pct3 <- round(df_ord$percentual[3], 1)
  
  texto <- glue::glue(
    "Em {ano}, entre os casos com detecÃ§Ã£o positiva por PCR na municipio, ",
    "o {top1} foi o agente mais frequente, representando {pct1}% dos registros. ",
    "Em seguida, destacaram-se o {top2} ({pct2}%) e o {top3} ({pct3}%). ",
    "Os demais vÃ­rus apresentaram participaÃ§Ã£o minoritÃ¡ria no total de detecÃ§Ãµes. ",
    "Esses dados reforÃ§am o papel dominante do {top1} na circulaÃ§Ã£o viral respiratÃ³ria ",
    "durante o ano, com evidÃªncia de cocirculaÃ§Ã£o de mÃºltiplos agentes etiolÃ³gicos."
  )
  
  return(texto)
}
texto_pcr <- gerar_texto_pcr_virus(df_tot, ano = ano_ref)
texto_pcr

```

## Tipo de vÃ­rus por Semana EpidemiolÃ³gica

```{r virus por SE, fig.width=9, fig.height=6,fig.height=6, fig.cap = paste0("Figura 4 â€“ ProporÃ§Ã£o de vÃ­rus detectados no PCR de SRAG por semana epidemiolÃ³gica, municipio -", ano_ref, "(n = ", sum(df_week$casos), ")")}
 cols_pcr <- names(virus_map)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1. Base de casos positivos por Semana EpidemiolÃ³gica (SE) e vÃ­rus
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
df_week <- srag %>%
  filter(ano == ano_ref) %>%
  select(SE, all_of(cols_pcr)) %>%
  mutate(SE = as.integer(SE)) %>%
  padroniza_pcr(cols = -SE) %>%                   # <- aqui
  pivot_longer(cols = -SE, names_to = "virus", values_to = "valor") %>%
  filter(valor == 1) %>%
  mutate(virus_nome = virus_map[virus]) %>%
  group_by(SE, virus_nome) %>%
  summarise(casos = n(), .groups = "drop")


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2. ProporÃ§Ã£o global do ano (para exibir na legenda)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
proporcoes <- df_week %>%
  group_by(virus_nome) %>%
  summarise(total = sum(casos), .groups = "drop") %>%
  mutate(percentual = total / sum(total) * 100,
         virus_legenda = paste0(virus_nome,
                                " (", round(percentual, 1), "%)"))
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3. Juntar proporÃ§Ã£o global na base principal
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
df_week <- df_week %>%
  left_join(proporcoes, by = "virus_nome")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 4. Calcular proporÃ§Ã£o semanal para grÃ¡fico 100 % empilhado
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
df_week_prop <- df_week %>%
  group_by(SE) %>%
  mutate(prop = casos / sum(casos)) %>%    # proporÃ§Ã£o na semana
  ungroup()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 5. GrÃ¡fico 100 % empilhado
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ggplot(df_week_prop,
       aes(x = SE,
           y = prop,
           fill = virus_legenda)) +

  geom_col(width = 0.95) +  # barras empilhadas
  scale_y_continuous(labels = percent_format(accuracy = 1)) +  # eixo em %
  scale_fill_brewer(palette = "Set3") +  # nova paleta

  labs(
    x = "Semana EpidemiolÃ³gica",
    y = "ProporÃ§Ã£o de VÃ­rus (%)",
    fill = "Tipo de VÃ­rus\n(participaÃ§Ã£o no ano)"
  ) +

  theme_minimal(base_size = 13) +
  theme(
    legend.title = element_text(face = "bold"),
    legend.text  = element_text(size = 9),
    axis.text.x  = element_text(angle = 45, hjust = 1)
  )





```

```{r  echo = FALSE, results='asis'}
gerar_texto_virus_temporal <- function(df_week, proporcoes, ano) {
  total_semanas <- length(unique(df_week$SE))
  
  virus_top <- proporcoes %>%
    arrange(desc(percentual)) %>%
    slice_head(n = 2)
  
  pico_semana <- df_week %>%
    group_by(SE) %>%
    summarise(total = sum(casos)) %>%
    slice_max(order_by = total, n = 1)
  
  texto <- glue::glue(
    "A anÃ¡lise da circulaÃ§Ã£o viral ao longo das semanas epidemiolÃ³gicas de {ano} mostra um padrÃ£o sazonal concentrado entre as semanas ",
    "{min(df_week$SE)} e {max(df_week$SE)}, com pico de detecÃ§Ãµes na semana {pico_semana$SE}, totalizando {pico_semana$total} registros. ",
    "O {virus_top$virus_nome[1]} foi o agente predominante, seguido por {virus_top$virus_nome[2]}. ",
    "Ambos apresentaram circulaÃ§Ã£o acentuada durante o perÃ­odo epidÃªmico, sugerindo cocirculaÃ§Ã£o. ",
    "Demais vÃ­rus, como os identificados por menor proporÃ§Ã£o, tiveram presenÃ§a limitada. ",
    "Esse comportamento reforÃ§a a importÃ¢ncia do monitoramento laboratorial contÃ­nuo para antecipaÃ§Ã£o de surtos e gestÃ£o de resposta em saÃºde pÃºblica."
  )
  
  return(texto)
}
texto_temporal <- gerar_texto_virus_temporal(df_week, proporcoes, ano = ano_ref)
texto_temporal
```

## Tipo de vÃ­rus por semana epidemiolÃ³gica e faixa etÃ¡ria

```{r virus por semana e faixa etaria,fig.width=9, fig.height=6, fig.cap = paste0("Figura 5 â€“ NÃºmero de casos por semana epidemiolÃ³gica, faixa etÃ¡ria e tipo de vÃ­rus ", ano_ref, "(n = ", nrow(srag_filtrado), ")")}

# ============================================================
# Casos por semana epidemiolÃ³gica, faixa etÃ¡ria (FE1) e vÃ­rus
# ============================================================

cols_pcr <- srag %>%
  select(
    matches("PCR"),                             # nome da coluna contÃ©m "PCR"
    where(~ all(.x %in% c(0, 1, NA)))          # valores possÃ­veis 0/1/NA
  ) %>%
  names()



cores_fe1 <- c(
  "80 e mais"  = "#08306B",
  "70 a 79"    = "#08519C",
  "60 a 69"    = "#2171B5",
  "50 a 59"    = "#4292C6",
  "40 a 49"    = "#6BAED6",
  "30 a 39"    = "#9ECAE1",
  "20 a 29"    = "#C6DBEF",
  "11 a 19"    = "#FDD0A2",
  "2 a 10"     = "#FDAE6B",
  "Menor de 2" = "#F16913"
)




# 1) Agregar os dados
srag_virus_fe <- srag %>%
  filter(
    ano == ano_ref,
    !is.na(FE1),
    !is.na(SE)
  ) %>%
  select(SE, FE1, all_of(cols_pcr)) %>%   # mantÃ©m FE1 + PCRs
  mutate(SE = as.integer(SE)) %>%
  
  # Converter os PCRs para formato longo
  pivot_longer(
    cols      = all_of(cols_pcr),
    names_to  = "virus_col",
    values_to = "valor"
  ) %>%
  
  # Apenas positivos (PCR = 1)
  filter(valor == 1) %>%
  
  # Atribuir nome legÃ­vel
  mutate(virus_nome = virus_map[virus_col]) %>%
  
  # Remover PCRs que nÃ£o estiverem no virus_map
  filter(!is.na(virus_nome)) %>%
  
  # Agregar
  group_by(SE, virus_nome, FE1) %>%
  summarise(
    casos = n(),
    .groups = "drop"
  )

srag_virus_fe$FE1 <- factor(
  srag_virus_fe$FE1,
  levels = c(
    "80 e mais",
    "70 a 79",
    "60 a 69",
    "50 a 59",
    "40 a 49",
    "30 a 39",
    "20 a 29",
    "11 a 19",
    "2 a 10",
    "Menor de 2"
  )
)

# 3) GrÃ¡fico de linhas com facetas por vÃ­rus
ggplot(srag_virus_fe,
       aes(x = SE, y = casos, fill = FE1)) +
  
  geom_col(position = "stack", width = 0.8) +
  
  facet_wrap(~ virus_nome, ncol = 2, scales = "free_y") +
  
  scale_y_continuous(name = "NÃºmero de casos") +
  
  scale_fill_manual(
    values = cores_fe1,
    name = "Faixa etÃ¡ria"
  ) +
  
  labs(
    x = "Semana EpidemiolÃ³gica",
  ) +
  
  theme_minimal(base_size = 13) +
  theme(
    axis.title.y   = element_text(color = "black", face = "bold"),
    axis.text.x    = element_text(face = "bold", color = "black", angle = 45, hjust = 1),
    axis.title.x   = element_text(face = "bold"),
    plot.title     = element_text(face = "bold", color = "black"),
    legend.position = "right"
  )





```
```{r Texto faixa etaria e virus, echo = FALSE,results='asis'}
# VÃ­rus mais frequente
virus_top <- srag_virus_fe %>%
  group_by(virus_nome) %>%
  summarise(total = sum(casos)) %>%
  arrange(desc(total)) %>%
  slice(1)

virus_nome_top <- virus_top$virus_nome
virus_total_top <- virus_top$total

# Semana com maior nÃºmero de casos (geral)
pico_geral <- srag_virus_fe %>%
  group_by(SE) %>%
  summarise(total = sum(casos)) %>%
  arrange(desc(total)) %>%
  slice(1)

se_pico <- pico_geral$SE
casos_pico <- pico_geral$total

# Faixa etÃ¡ria dominante nos vÃ­rus respiratÃ³rios
fe_top <- srag_virus_fe %>%
  group_by(FE1) %>%
  summarise(total = sum(casos)) %>%
  arrange(desc(total)) %>%
  slice(1)

faixa_dom <- fe_top$FE1

cat(
  paste0(
" 
O grÃ¡fico acima mostra a distribuiÃ§Ã£o dos casos por Semana EpidemiolÃ³gica (SE), estratificados por tipo de vÃ­rus respiratÃ³rio e faixa etÃ¡ria. Observa-se que", virus_nome_top,
" foi o vÃ­rus mais frequentemente identificado no perÃ­odo analisado, totalizando", virus_total_top,
" casos. O pico geral de casos ocorreu na SE ", se_pico, ", quando foram registrados", casos_pico,
" casos considerando todos os vÃ­rus combinados.  Em relaÃ§Ã£o ao perfil etÃ¡rio, a faixa que mais contribuiu para o total de casos foi", faixa_dom,
", indicando maior circulaÃ§Ã£o viral nesse grupo.  De maneira geral, nota-se que cada vÃ­rus apresenta padrÃµes distintos de sazonalidade e afeta principalmente faixas etÃ¡rias especÃ­ficas, o que reforÃ§a a importÃ¢ncia da vigilÃ¢ncia por laboratÃ³rio e da interpretaÃ§Ã£o conjunta de contexto epidemiolÃ³gico, sazonalidade e grupos populacionais mais expostos."
))

```



## HospitalizaÃ§Ãµes



```{r hospitalizacoes, fig.width=9, fig.height=6,fig.cap = paste0("Figura 6 â€“ NÃºmero de hospitalizaÃ§Ãµes de casos de SRAG por hospital, municipio -", ano_ref, "(n = ", total_notificacoes, ")")}

df_13 <- srag %>%
  filter(!is.na(NM_UN_INTE), ano == ano_ref) %>%
  group_by(NM_UN_INTE) %>%
  summarise(casos = n(), .groups = "drop")

ggplot(df_13, aes(x = casos, y = reorder(NM_UN_INTE, casos))) +
  geom_col(fill = "forestgreen", alpha = 0.7) +
  labs(
    x = "Casos",
    y = "Unidade"
  ) +
  theme_minimal(base_size = 12) +
  theme(axis.text.y = element_text(size = 10))



```

```{r Texto hospitalizacoes, echo = FALSE,results='asis'}
gerar_texto_hospitalizacoes <- function(df_unidades, ano) {
  total <- sum(df_unidades$casos)
  
  df_top <- df_unidades %>%
    arrange(desc(casos)) %>%
    slice(1:2) %>%
    mutate(percentual = round(casos / total * 100, 1))
  
  texto <- glue::glue(
    "Em {ano}, as hospitalizaÃ§Ãµes por SRAG na municipio concentraram-se majoritariamente em poucas unidades de saÃºde. ",
    "O destaque absoluto foi o {df_top$NM_UN_INTE[1]}, responsÃ¡vel por aproximadamente {df_top$percentual[1]}% de todas as internaÃ§Ãµes no perÃ­odo. ",
    "Na sequÃªncia, o {df_top$NM_UN_INTE[2]} tambÃ©m apresentou volume expressivo de hospitalizaÃ§Ãµes, com {df_top$percentual[2]}% dos casos. ",
    "As demais unidades registraram quantitativos inferiores, muitas com menos de 5 registros. ",
    "Esse padrÃ£o evidencia a centralizaÃ§Ã£o da assistÃªncia hospitalar em unidades especÃ­ficas, possivelmente relacionada Ã  capacidade instalada, ",
    "perfil populacional atendido ou Ã  definiÃ§Ã£o regional de referÃªncia para SRAG."
  )
  
  return(texto)
}

texto_hospitais <- gerar_texto_hospitalizacoes(df_13, ano = ano_ref)
texto_hospitais

```

## Faixa etÃ¡ria


```{r faixa etaria, fig.width=9, fig.height=6,fig.cap = paste0("Figura 7 â€“ ProporÃ§Ã£o casos de SRAG por faixa etÃ¡ria, municipio -", ano_ref, "(n = ", sum(df_week$casos), ")")}
df_2 <- srag %>%
      filter(!is.na(FE1) & ano == ano_ref) %>%
      mutate(FE1 = factor(FE1, levels = niveis_idade)) %>%
      group_by(FE1) %>%
      summarise(casos = n(), .groups = "drop") %>%
      mutate(percentual = round(casos / sum(casos) * 100, 1))

# Criar grÃ¡fico de faixa etÃ¡ria

  ggplot(df_2, aes(x = FE1, y = casos)) +
      geom_col(fill = "#4E79A7") +
      geom_text(aes(label = paste0(percentual, "%")),
                position = position_stack(vjust = 0.5), size = 5) +
      labs(x = "Faixa EtÃ¡ria", y = "Casos") +
      theme_minimal() +
      theme(legend.position = "none",
            axis.text.x = element_text(angle = 45, hjust = 1))
  
  

```

```{r Texto faixa etaria, echo = FALSE,results='asis'}
gerar_texto_faixa_etaria <- function(df_faixa, ano) {
  total <- sum(df_faixa$casos)
  
  top2 <- df_faixa %>%
    arrange(desc(casos)) %>%
    slice(1:2)
  
  soma_top2 <- sum(top2$percentual)
  
  idosos <- df_faixa %>%
    filter(FE1 %in% c("70 a 79", "80 ou mais")) %>%
    summarise(pct_idoso = sum(percentual)) %>%
    pull(pct_idoso)
  
  texto <- glue::glue(
    "Em {ano}, a anÃ¡lise da distribuiÃ§Ã£o etÃ¡ria dos casos de SRAG na municipio evidencia um perfil predominantemente pediÃ¡trico. ",
    "Cerca de {top2$percentual[1]}% dos registros ocorreram em {top2$FE1[1]}, enquanto {top2$percentual[2]}% concentraram-se em {top2$FE1[2]}. ",
    "Juntas, essas duas faixas etÃ¡rias representaram mais de {soma_top2}% do total de notificaÃ§Ãµes. ",
    "As demais faixas apresentaram percentuais reduzidos, com idosos acima de 70 anos representando {idosos}% dos casos. ",
    "Esse padrÃ£o reforÃ§a a importÃ¢ncia da vigilÃ¢ncia ativa em populaÃ§Ãµes infantis, especialmente nos perÃ­odos sazonais de maior circulaÃ§Ã£o viral."
  )
  
  return(texto)
}

texto_faixa <- gerar_texto_faixa_etaria(df_2, ano = ano_ref)
texto_faixa

```

## Menores de 2 anos



```{r proporcao_bebes,fig.width=9, fig.height=6,fig.cap = paste0("Figura 8 â€“ ProporÃ§Ã£o casos de SRAG por de bebÃªs menores de 1 ano por mÃªs e dias de vida, municipio -", ano_ref, "(n = ", sum(df_week$casos), ")")}
# Filtrar apenas bebÃªs com idade em dias (1) ou meses (2) e vÃ­rus positivo
df_3 <- srag %>%
  filter(TP_IDADE %in% c(1, 2), ano == ano_ref) %>%
  select(TP_IDADE, NU_IDADE_N, starts_with("PCR_")) %>%
  padroniza_pcr(cols = starts_with("PCR_")) %>%   # <- aqui
  pivot_longer(
    cols = starts_with("PCR_"),
    names_to = "virus_codigo",
    values_to = "positivo"
  ) %>%
  filter(positivo == 1) %>%
  mutate(
    Tipo = case_when(
      TP_IDADE == 1 ~ "Dias",
      TP_IDADE == 2 ~ "Meses"
    ),
    virus_nome = virus_map[virus_codigo],
    virus_nome = iconv(virus_nome, from = "", to = "UTF-8")
  ) %>%
  drop_na(virus_nome)



# Calcular proporÃ§Ã£o por idade e tipo
df_3_prop <- df_3 %>%
  group_by(Tipo, NU_IDADE_N) %>%
  summarise(n = n(), .groups = "drop") %>%
  group_by(Tipo) %>%
  mutate(prop = n / sum(n)) %>%
  ungroup()

ggplot(df_3_prop, aes(x = NU_IDADE_N, y = prop)) +
  geom_col(fill = "steelblue") +
  geom_text(aes(label = scales::percent(prop, accuracy = 0.1)),
            vjust = -0.3, size = 4) +
  facet_wrap(~Tipo, scales = "free") +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(
    x = "Idade",
    y = "ProporÃ§Ã£o de casos"
  ) +
  theme_minimal()



```

```{r Texto menores de 2 anos, echo = FALSE,results='asis' }
gerar_texto_srag_bebes <- function(df_3_prop, ano) {
  pico_dias <- df_3_prop %>%
    filter(Tipo == "Dias") %>%
    slice_max(prop, n = 1)
  
  pico_meses <- df_3_prop %>%
    filter(Tipo == "Meses") %>%
    slice_max(prop, n = 1)
  
  texto <- glue::glue(
    "A anÃ¡lise dos casos de SRAG com detecÃ§Ã£o viral entre bebÃªs na municipio, em {ano}, revela um padrÃ£o de maior concentraÃ§Ã£o ",
    "nas faixas etÃ¡rias mais precoces. Entre os recÃ©m-nascidos com idade registrada em dias, destaca-se um pico de casos aos ",
    "{pico_dias$NU_IDADE_N} dias de vida, responsÃ¡vel por {scales::percent(pico_dias$prop, accuracy = 0.1)} das notificaÃ§Ãµes desse subgrupo. ",
    "JÃ¡ entre os lactentes com idade expressa em meses, observa-se maior proporÃ§Ã£o de casos aos {pico_meses$NU_IDADE_N} mÃªs(es), representando ",
    "{scales::percent(pico_meses$prop, accuracy = 0.1)} das ocorrÃªncias. ",
    "Esse perfil reforÃ§a a vulnerabilidade imunolÃ³gica dos menores de 6 meses frente aos vÃ­rus respiratÃ³rios e destaca a importÃ¢ncia ",
    "de estratÃ©gias de proteÃ§Ã£o especÃ­ficas para essa faixa etÃ¡ria, como o monitoramento da circulaÃ§Ã£o viral, vacinaÃ§Ã£o de contatos ",
    "e fortalecimento da vigilÃ¢ncia laboratorial."
  )
  
  return(texto)
}

texto_bebes <- gerar_texto_srag_bebes(df_3_prop, ano = ano_ref)
texto_bebes
```

### Tiops de vÃ­rus identificados em bebÃªs

```{r virus por bebes, fig.width=9, fig.height=6,fig.cap = paste0("Figura 9 â€“ ProporÃ§Ã£o casos de SRAG por de bebÃªs menores de 1 ano por mÃªs e dias de vida e tipo de vÃ­rus detectados, municipio -", ano_ref, "(n = ", total_notificacoes, ")")}
# 1. Calcular proporÃ§Ãµes
df_3_prop <- df_3 %>%
  count(Tipo, NU_IDADE_N, virus_nome, name = "n") %>%
  group_by(Tipo, NU_IDADE_N) %>%
  mutate(prop = n / sum(n)) %>%
  ungroup()


# 2. GrÃ¡fico empilhado 100%
ggplot(df_3_prop, aes(x = NU_IDADE_N, y = prop, fill = virus_nome)) +
  geom_col(position = "fill") +
  facet_wrap(~Tipo, scales = "free") +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(
    x = "Idade",
    y = "ProporÃ§Ã£o (%)",
    fill = "VÃ­rus detectado"
  ) +
  theme_minimal() +
  theme(
    legend.title = element_text(face = "bold"),
    legend.text = element_text(size = 9),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  scale_fill_brewer(palette = "Set3")  # ou substitua por viridis/metbrewer






```

```{r Texto v[irus bebes], echo= FALSE,results='asis'}
df_virus <- df_3 %>%
  filter(!is.na(virus_nome)) %>%
  count(virus_nome, name = "n")

gerar_texto_virus_bebes <- function(df_virus, ano) {
  top_virus <- df_virus %>%
    group_by(virus_nome) %>%
    summarise(total = sum(n), .groups = "drop") %>%
    arrange(desc(total)) %>%
    slice(1:3)
  
  texto <- glue::glue(
    "A anÃ¡lise da distribuiÃ§Ã£o de vÃ­rus respiratÃ³rios entre bebÃªs com SRAG na municipio, em {ano}, mostra que o {top_virus$virus_nome[1]} foi o agente predominante ",
    "em praticamente todas as faixas etÃ¡rias avaliadas, especialmente nos primeiros meses de vida. ",
    "O {top_virus$virus_nome[2]} aparece como o segundo agente mais frequente, com detecÃ§Ãµes dispersas entre os meses iniciais. ",
    "O {top_virus$virus_nome[3]} teve menor participaÃ§Ã£o, mas esteve presente em vÃ¡rias faixas etÃ¡rias. ",
    "Esse padrÃ£o reforÃ§a o papel central do {top_virus$virus_nome[1]} nas hospitalizaÃ§Ãµes de bebÃªs, ",
    "ressaltando a importÃ¢ncia de aÃ§Ãµes preventivas especÃ­ficas como imunizaÃ§Ã£o materna e medidas de proteÃ§Ã£o precoce."
  )
  
  return(texto)
}

texto_virus_bebes <- gerar_texto_virus_bebes(df_virus, ano = ano_ref)
texto_virus_bebes
```

## Uso de ventilaÃ§Ã£o

```{r ventilacao, fig.width=9, fig.height=6,fig.cap = paste0("Figura 10 â€“ ProporÃ§Ã£o casos de SRAG por uso de suporte ventilatÃ³rio, municipio -", ano_ref, "(n = ", total_notificacoes, ")")}
 df_4 <- srag %>%
   filter(ano == ano_ref, !is.na(SUPORT_VEN2)) |>
      count(SUPORT_VEN2) %>%
      rename(casos = n) %>%
      mutate(percentual = round(casos / sum(casos) * 100, 1))
    
  ggplot(df_4, aes(x = SUPORT_VEN2, y = casos)) +
      geom_col(fill = "#E15759") +
      geom_text(aes(label = paste0(percentual, "%")),
                position = position_stack(vjust = 0.5), size = 5) +
      labs(x = "Tipo de Suporte", y = "Casos") +
      theme_minimal() +
      theme(axis.text.x = element_text(angle = 45, hjust = 1),
            legend.position = "none")
  
  

    
```

```{r Texto ventilacao, echo = FALSE,results='asis'}
gerar_texto_suporte_ventilatorio <- function(df_4, ano) {
  df_ord <- df_4 %>% arrange(desc(casos))
  
  suporte1 <- df_ord$SUPORT_VEN2[1]
  pct1     <- df_ord$percentual[1]
  
  suporte2 <- df_ord$SUPORT_VEN2[2]
  pct2     <- df_ord$percentual[2]
  
  suporte3 <- df_ord$SUPORT_VEN2[3]
  pct3     <- df_ord$percentual[3]
  
  texto <- glue::glue(
    "Em {ano}, entre os casos de SRAG internados na municipio, observou-se que a maioria dos pacientes ({pct1}%) recebeu {tolower(suporte1)}, ",
    "seguido por {pct2}% que necessitaram de {tolower(suporte2)}. ",
    "Apenas {pct3}% dos pacientes nÃ£o utilizaram suporte ventilatÃ³rio. ",
    "Esse padrÃ£o sugere uma carga significativa de casos graves, com demanda elevada por suporte respiratÃ³rio, ",
    "reforÃ§ando a importÃ¢ncia do preparo da rede assistencial em perÃ­odos epidÃªmicos."
  )
  
  return(texto)
}

texto_ventilacao <- gerar_texto_suporte_ventilatorio(df_4, ano = ano_ref)
texto_ventilacao

```

## Ã“bitos


```{r obitos, fig.width=9, fig.height=6,fig.cap = paste0("Figura 11 â€“ NÃºmero de Ã³bitos por SRAG por semana epidmeiolÃ³gica, municipio -", ano_ref, "(n = ", sum(df_5$obitos), ")")}
df_5 <- srag%>%
  filter(ano == ano_ref) |>
      group_by(ano, SE) %>%
      summarise(obitos = sum(OBITOSRAG == "Sim", na.rm = TRUE), .groups = "drop")
  
   ggplot(df_5, aes(x =SE, y = obitos)) +
      geom_col(fill = "red") +
      labs( x = "Ano", y = "Ã“bitos") +
      theme_minimal()
  # Tabela com SE, vÃ­rus, faixa etÃ¡ria e nÃºmero de Ã³bitos
tabela_obitos <- srag %>%
  filter(OBITOSRAG == "Sim", !is.na(FE1), ano == ano_ref) %>%
  select(SE, municipio, FE1, starts_with("PCR_")) %>%
  padroniza_pcr(cols = starts_with("PCR_")) %>%   # <- aqui (resolve o character vs logical)
  pivot_longer(
    cols = starts_with("PCR_"),
    names_to = "virus_codigo",
    values_to = "positivo"
  ) %>%
  filter(positivo == 1) %>%
  mutate(
    virus_nome = virus_map[virus_codigo],
    virus_nome = iconv(virus_nome, from = "", to = "UTF-8"),
    FE1 = factor(FE1, levels = niveis_idade),
    municipio = as.factor(municipio)
  ) %>%
  drop_na(virus_nome) %>%
  group_by(SE, virus_nome, FE1, municipio) %>%
  summarise(obitos = n(), .groups = "drop")


# Exibir a tabela (em HTML)
if (knitr::is_html_output()) {
  DT::datatable(
    tabela_obitos,
    caption = "Ã“bitos por Semana EpidemiolÃ³gica, Tipo de VÃ­rus e Faixa EtÃ¡ria",
    rownames = FALSE,
    options = list(pageLength = 10, scrollX = TRUE)
  )
} else {
  knitr::kable(
    tabela_obitos,
    caption = "Ã“bitos por Semana EpidemiolÃ³gica, Tipo de VÃ­rus e Faixa EtÃ¡ria"
  )
}



```

```{r Texto obitos, echo = FALSE,results='asis'}
gerar_texto_obitos_semanal <- function(df_obitos, ano) {
  
  total_obitos <- sum(df_obitos$obitos, na.rm = TRUE)
  
  semanas_com_obito <- df_obitos %>%
    filter(obitos > 0)
  
  n_semanas <- nrow(semanas_com_obito)
  
  if (total_obitos == 0) {
    
    return(glue::glue(
      "Em {ano}, nÃ£o foram registrados Ã³bitos por SRAG no municÃ­pio. ",
      "O cenÃ¡rio indica ausÃªncia de letalidade no perÃ­odo analisado, ",
      "mantendo-se recomendaÃ§Ã£o de vigilÃ¢ncia contÃ­nua para detecÃ§Ã£o precoce de possÃ­veis mudanÃ§as no padrÃ£o de gravidade."
    ))
    
  } else {
    
    semana_pico <- semanas_com_obito %>%
      arrange(desc(obitos)) %>%
      slice(1)
    
    return(glue::glue(
      "Em {ano}, foram registrados {total_obitos} Ã³bitos por SRAG distribuÃ­dos em {n_semanas} semanas epidemiolÃ³gicas. ",
      "A maior concentraÃ§Ã£o ocorreu na semana {semana_pico$SE}, com {semana_pico$obitos} Ã³bito(s). ",
      "O padrÃ£o observado sugere ocorrÃªncia pontual de gravidade, sem manutenÃ§Ã£o sustentada de mortalidade ao longo do perÃ­odo."
    ))
  }
}



```

## InternaÃ§Ã£o por faixa etÃ¡ria

```{r internacao, fig.width=9, fig.height=6,fig.cap = paste0("Figura 12 â€“ Tempo de internaÃ§Ã£o (em dias) por faixa etÃ¡ria, municipio -", ano_ref, "(n = ", total_notificacoes, ")")}
df_6 <- srag %>%
      filter(!is.na(Tempo_Evolucao), !is.na(FE1), ano == ano_ref) %>%
      # garante a ordem correta das faixas
      mutate(FE1 = factor(FE1, levels = niveis_idade))
    
  ggplot(df_6, aes(x = FE1, y = Tempo_Evolucao)) +
      geom_boxplot(fill = "#59A14F") +
      labs(
        title = paste("Tempo de InternaÃ§Ã£o (dias) por Faixa EtÃ¡ria",ano_ref),
        x     = "Faixa EtÃ¡ria",
        y     = "Dias"
      ) +
      theme_minimal() +
      theme(axis.text.x = element_text(angle = 45, hjust = 1))
  
  

```

```{r Texto faixa etaria e tempo de internacao, echo = FALSE,results='asis'}
gerar_texto_tempo_internacao <- function(df_6, ano) {
  # Medianas por faixa etÃ¡ria
  resumo <- df_6 %>%
    group_by(FE1) %>%
    summarise(mediana = median(Tempo_Evolucao, na.rm = TRUE), .groups = "drop") %>%
    arrange(desc(mediana))
  
  faixa_top1 <- resumo$FE1[1]
  med_top1   <- resumo$mediana[1]
  
  faixa_top2 <- resumo$FE1[2]
  med_top2   <- resumo$mediana[2]
  
  faixa_inf <- resumo %>%
    filter(FE1 %in% c("Menor de 2", "2 a 10")) %>%
    summarise(mediana = round(mean(mediana, na.rm = TRUE), 1)) %>%
    pull(mediana)
  
  texto <- glue::glue(
    "Em {ano}, a anÃ¡lise da duraÃ§Ã£o das internaÃ§Ãµes por SRAG na municipio revelou diferenÃ§as expressivas entre as faixas etÃ¡rias. ",
    "Pacientes com {faixa_top1} apresentaram os maiores tempos de internaÃ§Ã£o, com mediana de aproximadamente {med_top1} dias, ",
    "seguido pelo grupo de {faixa_top2}, com {med_top2} dias. ",
    "JÃ¡ entre crianÃ§as menores de 10 anos, as internaÃ§Ãµes foram significativamente mais curtas, com mediana mÃ©dia de {faixa_inf} dias. ",
    "Esses achados destacam a maior complexidade clÃ­nica entre adultos e idosos, com impacto direto na carga assistencial e uso prolongado de leitos hospitalares."
  )
  
  return(texto)
}
texto_internacao <- gerar_texto_tempo_internacao(df_6, ano = ano_ref)
texto_internacao
```

## EvoluÃ§Ã£o

```{r evolucao, fig.width=9, fig.height=6,fig.cap = paste0("Figura 13 â€“ ProporÃ§Ã£o de casos de SRAG segundo evoluÃ§Ã£o, municipio -", ano_ref, "(n = ", total_notificacoes, ")")}
df_9 <- srag%>%
      filter(!is.na(EVOL1), ano == ano_ref) %>%
      group_by(EVOL1) %>% summarise(casos=n(), .groups="drop") |>
      mutate(percentual = round(casos / sum(casos) * 100, 1))

  ggplot(df_9, aes(x=reorder(EVOL1, casos), y=casos)) +
      geom_col(fill="#F28E2B") +
    geom_text(aes(label = paste0(percentual, "%")),
                position = position_stack(vjust = 0.5), size = 5) +
      labs(title=paste("Percentual de internaÃ§Ã£o por tipo de evoluÃ§Ã£o na municipio",ano_ref), x="Desfecho", y="Casos") +
      theme_minimal() + theme(legend.position="none")
  


```

```{r TEXTO EVOLUCAO, echo = FALSE,results='asis'}
gerar_texto_evolucao <- function(df_9, ano) {
  df_ordenado <- df_9 %>% arrange(desc(casos))
  
  cura_pct <- df_ordenado %>% filter(grepl("Cura", EVOL1)) %>% pull(percentual)
  ignorado_pct <- df_ordenado %>% filter(grepl("Ignorado", EVOL1)) %>% pull(percentual)
  obito_srag <- df_ordenado %>% filter(grepl("^Ã“bito$", EVOL1)) %>% pull(percentual)
  obito_outros <- df_ordenado %>% filter(grepl("outras causas", EVOL1)) %>% pull(percentual)
  
  texto <- glue::glue(
    "Em {ano}, a maioria dos casos internados por SRAG na municipio evoluiu para cura, representando {cura_pct}% dos registros com desfecho informado. ",
    "Cerca de {ignorado_pct}% dos casos permaneceram com evoluÃ§Ã£o ignorada, o que indica ausÃªncia de encerramento adequado no sistema. ",
    "A letalidade observada foi baixa: {obito_srag}% dos casos evoluÃ­ram para Ã³bito por SRAG, e {obito_outros}% para Ã³bito por outras causas. ",
    "Enquanto a alta proporÃ§Ã£o de cura aponta para um manejo clÃ­nico eficaz, a presenÃ§a significativa de registros ignorados evidencia a importÃ¢ncia de fortalecer a vigilÃ¢ncia e qualificaÃ§Ã£o dos dados de encerramento."
  )
  
  return(texto)
}

  texto_evolucao <- gerar_texto_evolucao(df_9, ano = ano_ref)
texto_evolucao

```

# Diagrama de controle de SRAG 

```{r diagrama de controle Leste, fig.width=9, fig.height=6,fig.cap = paste0("Figura 14 â€“ Diagrama de controle de SRAG por semana epidmeiolÃ³gica, municipio -", ano_ref, ".")}
anos_hist <- (ano_ref - 10):(ano_ref - 1)

# Juntar com populaÃ§Ã£o correta
df_10 <- srag %>%
  left_join(pop, by = c("ano", "municipio")) %>%
  filter(!is.na(populacao)) %>%
  mutate(incidencia = 100000 / populacao)  # 1 caso por linha

# HistÃ³rico
historico <- df_10 %>%
   filter(ano %in% anos_hist, !ano %in% ano_epidemico) %>%
  group_by(SE, ano) %>%
  summarise(casos = n(), pop = populacao, .groups = "drop") %>%
  mutate(inc = 100000 * casos / pop)

limiares <- historico %>%
  group_by(SE) %>%
  summarise(
    media = mean(inc),
    sd = sd(inc),
    lim_1 = media + sd,
    lim_2 = media + 2 * sd,
    lim_3 = media + 3 * sd,
    .groups = "drop"
  )

# Dados atuais (ano de referÃªncia)
atual <- df_10 %>%
  filter(ano == ano_ref) %>%
  group_by(SE) %>%
  summarise(casos = n(), pop = first(populacao), .groups = "drop") %>%
  mutate(inc = 100000 * casos / pop)


#Nowcasting dos casos

# Calcular a mÃ©dia mÃ³vel (lag = 1, para nÃ£o usar valores futuros)
atual <- atual %>%
  arrange(SE) %>%
  mutate(
    inc_ma = rollmean(inc, k = 4, align = "right", fill = NA)
  )

# Ãšltima SE registrada no ano de referÃªncia
ultima_SE <- max(atual$SE, na.rm = TRUE)

# Fator de correÃ§Ã£o fixo (exemplo: 1.2). VocÃª pode usar um nowcast_fator se quiser.
fator_nowcasting <- 1.2

# Corrigir nas 4 Ãºltimas semanas com base na mÃ©dia mÃ³vel
nowcast <- atual %>%
  filter(SE >= (ultima_SE - 8), SE <= ultima_SE-1) %>%
  mutate(
    inc_corrigida = inc_ma,
    ic_low = inc_corrigida * 0.9,
    ic_up  = inc_corrigida * 1.1
  ) %>%
  drop_na(inc_corrigida)


# GrÃ¡fico
# ðŸ–¼ GrÃ¡fico com legenda
caption_text <- paste0(
  "Anos de referÃªncia para os limiares ", 
  min(filtro_ano), " a ", max(filtro_ano), 
  ". Retirando o ano epidÃªmico de:", ano_epidemico
)

ggplot() +
  geom_ribbon(data = limiares, aes(x = SE, ymin = 0, ymax = media, fill = "Zona de controle"), alpha = 0.3) +
  geom_ribbon(data = limiares, aes(x = SE, ymin = media, ymax = lim_1, fill = "Zona de seguranÃ§a"), alpha = 0.3) +
  geom_ribbon(data = limiares, aes(x = SE, ymin = lim_1, ymax = lim_2, fill = "Zona de alerta"), alpha = 0.3) +
  geom_ribbon(data = limiares, aes(x = SE, ymin = lim_2, ymax = lim_3, fill = "Zona epidÃªmica"), alpha = 0.3) +

  geom_line(data = atual, aes(x = SE, y = inc, color = "Incidencia atual"), size = 1.2) +

  # Nowcasting
  geom_ribbon(data = nowcast, aes(x = SE, ymin = ic_low, ymax = ic_up),
            fill = "gray50", alpha = 0.3) +
geom_line(data = nowcast, aes(x = SE, y = inc_corrigida, color = "Incidencia corrigida"),
          linewidth = 1.2)+


  labs(
    x = "Semana EpidemiolÃ³gica",
    y = "IncidÃªncia por 100 mil hab.",
    fill = "Faixas de risco",
    color = "",
    caption = caption_text
  ) +
  scale_fill_manual(
  values = c(
      "Zona de controle" = "green",
      "Zona de seguranÃ§a" = "yellow",
      "Zona de alerta" = "orange",
      "Zona epidÃªmica" = "red"
  ),
   breaks = c("Zona de controle", "Zona de seguranÃ§a", "Zona de alerta", "Zona epidÃªmica")
)+
  scale_color_manual(values = c("Incidencia atual" = "blue", "Incidencia corrigida" = "red")) +
  theme_minimal() +
  theme(legend.position = "right")
```

```{r Texto Diagrama de controle, echo=FALSE, results='asis',results='asis'}
gerar_bloco_diagrama_controle_recente <- function(atual, limiares, nowcast, ano, municipio = "Brasilia") {
  library(dplyr)
  library(glue)
  
  # Determinar Ãºltimas 4 semanas disponÃ­veis no nowcast
  semanas_recentes <- tail(sort(nowcast$SE), 4)

  # Classificar zona apenas para semanas recentes
  zonas_recentes <- nowcast %>%
  filter(SE %in% semanas_recentes) %>%
  left_join(limiares, by = "SE") %>%
  mutate(
    zona = case_when(
      inc_corrigida <= media ~ "zona de controle",
      inc_corrigida <= lim_1 ~ "zona de seguranÃ§a",
      inc_corrigida <= lim_2 ~ "zona de alerta",
      TRUE                  ~ "zona epidÃªmica"
    )
  )


  # Zona predominante nas Ãºltimas 4 semanas
  zona_predom <- zonas_recentes %>%
    count(zona) %>%
    arrange(desc(n)) %>%
    slice(1) %>%
    pull(zona)

 cor_emojis <- c(
  "zona de controle" = "<span style='color:#2ECC71'>&#9679;</span>",     # verde
  "zona de seguranÃ§a" = "<span style='color:#F1C40F'>&#9679;</span>",    # amarelo
  "zona de alerta" = "<span style='color:#E67E22'>&#9679;</span>",       # laranja
  "zona epidÃªmica" = "<span style='color:#E74C3C'>&#9679;</span>"        # vermelho
)


  cor_nomes <- c(
    "zona de controle" = "verde",
    "zona de seguranÃ§a" = "amarelo",
    "zona de alerta" = "laranja",
    "zona epidÃªmica" = "vermelho"
  )

  emoji <- cor_emojis[zona_predom]
  cor_nome <- cor_nomes[zona_predom]

  # TendÃªncia recente do nowcasting
  nowcast <- nowcast %>% arrange(SE)
  delta <- if (nrow(nowcast) >= 2) {
    last(nowcast$inc_corrigida) - dplyr::lag(nowcast$inc_corrigida, 1) %>% last()
  } else {
    0
  }

  tendencia <- case_when(
    delta < -0.5 ~ "declÃ­nio",
    delta > 0.5  ~ "aumento",
    TRUE         ~ "estabilidade"
  )

  # Texto final
  glue::glue(
"
 Nas Ãºltimas 4 semanas epidemiolÃ³gicas analisadas, os nÃ­veis de incidÃªncia de SRAG no {municipio} mantiveram-se predominantemente na **{emoji} {zona_predom}**.  
 
A tendÃªncia da curva corrigida por atraso de notificaÃ§Ã£o indica um padrÃ£o de **{tendencia}**, sugerindo que o cenÃ¡rio atual tende a se **manter ou evoluir em curto prazo** nessa mesma zona de risco.  
 
Com base na situaÃ§Ã£o recente, recomenda-se a ativaÃ§Ã£o do **nÃ­vel {emoji} _{cor_nome}_** do plano de contingÃªncia, com foco nas seguintes aÃ§Ãµes:

* ReforÃ§o da vigilÃ¢ncia e encerramento oportuno de casos;  
* AvaliaÃ§Ã£o da capacidade de resposta hospitalar e laboratorial;  
* ComunicaÃ§Ã£o contÃ­nua com equipes locais e populaÃ§Ã£o em risco.
"
  )
}

bloco_recentes <- gerar_bloco_diagrama_controle_recente(atual, limiares, nowcast, ano = ano_ref)
bloco_recentes


```


## Diagrama de controle por municÃ­pio

```{r Diagrama de controle por RA, fig.width=14, fig.height=10,fig.cap = paste0("Figura 15 â€“ Diagrama de controle de SRAG por semana epidmeiolÃ³gica e municipio, municipio -", ano_ref, ".")}


# Preparar base com incidÃªncia (como antes)
df_ra <- srag %>%
  left_join(pop, by = c("ano", "municipio")) %>%
  filter(!is.na(populacao)) %>%
  mutate(incidencia = 100000 / populacao)

# Anos de histÃ³rico (excluindo anos epidÃªmicos)
anos_hist <- (ano_ref - 10):(ano_ref - 1)
anos_hist <- setdiff(anos_hist, ano_epidemico)

# Limiares por RA
historico_ra <- df_ra %>%
  filter(ano %in% anos_hist) %>%
  group_by(SE, municipio, ano) %>%  # <-- adiciona o ano
  summarise(casos = n(), pop = first(populacao), .groups = "drop") %>%
  mutate(inc = 100000 * casos / pop)


limiares_ra <- historico_ra %>%
  group_by(SE, municipio) %>%
  summarise(
    media = mean(inc),
    sd = sd(inc),
    lim_1 = media - 2* sd,
    lim_2 = media + 2 * sd,
    lim_3 = media + 3 * sd,
    .groups = "drop"
  )


# Dados atuais
atual_ra <- df_ra %>%
  filter(ano == ano_ref) %>%
  group_by(SE, municipio) %>%
  summarise(casos = n(), pop = mean(populacao), .groups = "drop") %>%
  mutate(inc = 100000 * casos / pop) %>%
  arrange(municipio, SE) %>%
  group_by(municipio) %>%
  mutate(inc_ma = zoo::rollmean(inc, k = 4, align = "right", fill = NA)) %>%
  ungroup()

municipios_sel <- unique(atual_ra$municipio)
n_municipios <- length(municipios_sel)

# Ãšltimas 5 semanas por RA
ultima_SE <- max(atual_ra$SE, na.rm = TRUE)

nowcast_ra <- atual_ra %>%
  filter(SE >= (ultima_SE - 8), SE <= ultima_SE-1) %>%
  mutate(
    inc_corrigida = inc_ma,
    ic_low = inc_corrigida * 0.9,
    ic_up  = inc_corrigida * 1.1
  ) %>%
  drop_na(inc_corrigida)


if (n_municipios == 0) {
  
  cat("Sem dados suficientes para gerar o diagrama de controle por municÃ­pio neste perÃ­odo.")
  
} else {
  
  p <- ggplot() +
    geom_ribbon(data = limiares_ra, aes(x = SE, ymin = 0, ymax = media, fill = "Zona de controle"), alpha = 0.3) +
    geom_ribbon(data = limiares_ra, aes(x = SE, ymin = media, ymax = lim_1, fill = "Zona de seguranÃ§a"), alpha = 0.3) +
    geom_ribbon(data = limiares_ra, aes(x = SE, ymin = lim_1, ymax = lim_2, fill = "Zona de alerta"), alpha = 0.3) +
    geom_ribbon(data = limiares_ra, aes(x = SE, ymin = lim_2, ymax = lim_3, fill = "Zona epidÃªmica"), alpha = 0.3) +

    geom_line(data = atual_ra, aes(x = SE, y = inc, color = "IncidÃªncia atual"), linewidth = 1) +

    geom_ribbon(data = nowcast_ra, aes(x = SE, ymin = ic_low, ymax = ic_up), fill = "gray50", alpha = 0.3) +
    geom_line(data = nowcast_ra, aes(x = SE, y = inc_corrigida, color = "IncidÃªncia corrigida"),
              linewidth = 1.1) +

    scale_fill_manual(
      values = c(
        "Zona de controle" = "green",
        "Zona de seguranÃ§a" = "yellow",
        "Zona de alerta" = "orange",
        "Zona epidÃªmica" = "red"
      )
    ) +
    scale_color_manual(values = c(
      "IncidÃªncia atual" = "blue",
      "IncidÃªncia corrigida" = "red"
    )) +
    labs(
      x = "Semana EpidemiolÃ³gica",
      y = "IncidÃªncia por 100 mil hab.",
      fill = "Faixas de risco",
      color = "",
      caption = caption_text
    ) +
    theme_minimal() +
    theme(
      legend.position = "right",
      strip.text = element_text(face = "bold", size = 11)
    )

  # Se tiver mais de 1 municÃ­pio, aplica facet
  if (n_municipios > 1) {
    p <- p + facet_wrap(~municipio, scales = "free_y")
  }

  print(p)
}




```

```{r Texto diagrama por RA, echo = FALSE,results='asis'}
gerar_tabela_diagrama_ra <- function(atual_ra, limiares_ra, nowcast_ra, ano) {
  library(dplyr)

  # Se nÃ£o tem nowcast, devolve tabela vazia padronizada
  if (is.null(nowcast_ra) || nrow(nowcast_ra) == 0) {
    return(tibble::tibble(
      Zona_de_Risco = character(),
      `municipio` = character(),
      RecomendaÃ§Ã£o = character()
    ))
  }

  ra_list <- unique(nowcast_ra$municipio)

  cor_emojis <- c(
    "zona de controle" = "<span style='color:#2ECC71'>&#9679;</span>",
    "zona de seguranÃ§a" = "<span style='color:#F1C40F'>&#9679;</span>",
    "zona de alerta" = "<span style='color:#E67E22'>&#9679;</span>",
    "zona epidÃªmica" = "<span style='color:#E74C3C'>&#9679;</span>"
  )

  cor_nomes <- c(
    "zona de controle" = "verde",
    "zona de seguranÃ§a" = "amarelo",
    "zona de alerta" = "laranja",
    "zona epidÃªmica" = "vermelho"
  )

  linhas <- lapply(ra_list, function(ra) {

    dados_limiar  <- limiares_ra %>% filter(municipio == ra)
    dados_nowcast <- nowcast_ra %>% filter(municipio == ra) %>% arrange(SE)

    # Se alguma RA nÃ£o tem limiar/nowcast, pula
    if (nrow(dados_nowcast) == 0 || nrow(dados_limiar) == 0) return(NULL)

    semanas_finais <- tail(sort(unique(dados_nowcast$SE)), 4)
    if (length(semanas_finais) == 0) return(NULL)

    zonas_finais <- dados_nowcast %>%
      filter(SE %in% semanas_finais) %>%
      left_join(dados_limiar, by = "SE") %>%
      mutate(
        zona = case_when(
          inc_corrigida <= media ~ "zona de controle",
          inc_corrigida <= lim_1 ~ "zona de seguranÃ§a",
          inc_corrigida <= lim_2 ~ "zona de alerta",
          TRUE                   ~ "zona epidÃªmica"
        )
      )

    if (nrow(zonas_finais) == 0) return(NULL)

    zona_predom <- zonas_finais %>%
      count(zona) %>%
      arrange(desc(n)) %>%
      slice(1) %>%
      pull(zona)

    # Fallback se vier algo inesperado
    if (is.na(zona_predom) || !(zona_predom %in% names(cor_emojis))) zona_predom <- "zona de controle"

    emoji <- cor_emojis[[zona_predom]]
    cor_nome <- cor_nomes[[zona_predom]]

    delta <- if (nrow(dados_nowcast) >= 2) {
      last(dados_nowcast$inc_corrigida) - dplyr::lag(dados_nowcast$inc_corrigida, 1) %>% last()
    } else 0

    tendencia <- case_when(
      delta < -0.5 ~ "declÃ­nio",
      delta > 0.5  ~ "aumento",
      TRUE         ~ "estabilidade"
    )

    texto <- paste0(
      "Nas Ãºltimas semanas, a incidÃªncia de SRAG manteve-se predominantemente na **",
      emoji, " ", zona_predom, "**, com tendÃªncia de **", tendencia, "**. ",
      "Recomenda-se ativar o nÃ­vel **", cor_nome, "** do plano de contingÃªncia, com reforÃ§o da vigilÃ¢ncia e atenÃ§Ã£o aos indicadores locais."
    )

    tibble::tibble(
      Zona_de_Risco = paste(emoji, zona_predom),
      `municipio` = ra,
      RecomendaÃ§Ã£o = texto
    )
  })

  out <- dplyr::bind_rows(linhas)

  # Garante colunas mesmo se out estiver vazio
  if (nrow(out) == 0) {
    out <- tibble::tibble(
      Zona_de_Risco = character(),
      `municipio` = character(),
      RecomendaÃ§Ã£o = character()
    )
  }

  out
}

tabela_diagrama <- gerar_tabela_diagrama_ra(atual_ra, limiares_ra, nowcast_ra, ano = ano_ref)

knitr::kable(
  tabela_diagrama,
  format = "pandoc",
  escape = FALSE,
  align = "l",
  col.names = c("Zona de Risco", "municipio", "RecomendaÃ§Ã£o")
)


```



# Taxa de transmissibilidade viral

```{r transmissibilidade-por-ra, warning=FALSE, message=FALSE, fig.width=13, fig.height=10, results='asis',fig.cap = paste0("Figura 16 â€“ Taxa de transmissibilidade viral (RT) por semana epidmeiolÃ³gica e municipio, municipio -", ano_ref, ")")}
# Lista com um grÃ¡fico por RA (faceteando os vÃ­rus dentro de cada RA)
# DicionÃ¡rio de nomes corrigidos


# 1. Identificar colunas de PCR confirmadas
col_pcr <- grep("^PCR_", names(srag), value = TRUE)
col_pcr <- setdiff(col_pcr, "PCR_RESUL")

# 2. Base longa com vÃ­rus confirmados
srag_long <- srag %>%
  filter(ano == ano_ref)|>
  select(municipio, DT_SIN_PRI, all_of(col_pcr)) %>%
  pivot_longer(cols = all_of(col_pcr), names_to = "virus", values_to = "confirmado") %>%
  filter(confirmado == 1, !is.na(DT_SIN_PRI)) %>%
  mutate(
    semana = epiweek(DT_SIN_PRI),
    ano = year(DT_SIN_PRI),
    virus_traduzido = virus_map[virus]
  )

# 3. IncidÃªncia por semana, vÃ­rus, RA
incidencia <- srag_long %>%
  group_by(ano, semana, municipio, virus_traduzido) %>%
  summarise(casos = n(), .groups = "drop") %>%
  left_join(pop, by = c("ano", "municipio")) %>%
  mutate(incidencia_100k = casos / populacao * 1e5)

# 4. FunÃ§Ã£o para calcular Rt por vÃ­rus/RA
calcular_rt <- function(df) {
  if (nrow(df) < 8) return(NULL)
  incid <- df %>% arrange(ano, semana) %>% pull(casos)

  config <- make_config(list(mean_si = 3.5, std_si = 2.5))

  res <- tryCatch({
    estimate_R(incid, method = "parametric_si", config = config)
  }, error = function(e) NULL)

  if (is.null(res)) return(NULL)

  data.frame(
    t = res$R$t_end,
    Rt = res$R$`Mean(R)`,
    low = res$R$`Quantile.0.025(R)`,
    high = res$R$`Quantile.0.975(R)`,
    semana = df$semana[res$R$t_end],
    ano = df$ano[res$R$t_end],
    municipio = df$municipio[1],
    virus = df$virus_traduzido[1]
  )
}

# 5. Aplicar por grupo
resultados_rt <- incidencia %>%
  group_split(municipio, virus_traduzido) %>%
  map_dfr(calcular_rt)

# âœ… Guard rail
if (is.null(resultados_rt) || nrow(resultados_rt) == 0) {

  cat(glue::glue(
    "NÃ£o foi possÃ­vel estimar Rt para {ano_ref} (dados insuficientes por vÃ­rus/RA, ou ausÃªncia de sÃ©ries com pelo menos 8 semanas).\n"
  ))

} else {

  graficos_ra <- resultados_rt %>%
    split(.$municipio) %>%
    map(~ {
      df_ra <- .x

      # Se por algum motivo vier vazio, retorna NULL (serÃ¡ removido depois)
      if (nrow(df_ra) == 0) return(NULL)

      ultima_semana <- df_ra %>%
        group_by(virus) %>%
        filter(semana == max(semana, na.rm = TRUE)) %>%
        ungroup()

      ggplot(df_ra, aes(x = semana, y = Rt)) +
        geom_line(color = "#1f77b4") +
        geom_ribbon(aes(ymin = low, ymax = high), fill = "#aec7e8", alpha = 0.3) +
        geom_hline(yintercept = 1, linetype = "dashed", color = "red") +
        geom_text(
          data = ultima_semana,
          aes(label = sprintf("Rt: %.2f", Rt)),
          vjust = -0.5, hjust = 1, size = 5, color = "black"
        ) +
        facet_wrap(~ virus, scales = "free_y", ncol = 2) +
        labs(
          title = unique(df_ra$municipio),
          x = "Semana EpidemiolÃ³gica", y = "Rt estimado"
        ) +
        theme_minimal(base_size = 14)
    })

  # âœ… Remove NULLs
  graficos_ra <- purrr::compact(graficos_ra)

  # âœ… Se ficou vazio apÃ³s compact, nÃ£o chama wrap_plots
  if (length(graficos_ra) == 0) {
    cat(glue::glue(
      "NÃ£o foi possÃ­vel gerar grÃ¡ficos de Rt para {ano_ref} (sem sÃ©ries vÃ¡lidas apÃ³s filtragens).\n"
    ))
  } else {
    grid_completo <- patchwork::wrap_plots(graficos_ra, ncol = 2)
    grid_completo
  }
}

```


```{r Texto RT, echo=FALSE, results='asis'}

# âœ… Se resultados_rt nÃ£o existe / estÃ¡ vazio, nÃ£o tenta interpretar
if (!exists("resultados_rt") || is.null(resultados_rt) || nrow(resultados_rt) == 0) {

  cat(glue::glue(
    "### Resumo por municipio â€“ Rt mais recente por vÃ­rus\n\n",
    "NÃ£o foi possÃ­vel estimar Rt para {ano_ref} (dados insuficientes por vÃ­rus/RA ou sÃ©ries muito curtas).\n"
  ))

} else {

  interpretacao_por_ra_virus <- resultados_rt %>%
    # garante que a coluna existe mesmo em casos estranhos
    dplyr::filter("Rt" %in% names(.)) %>%
    dplyr::filter(!is.na(Rt)) %>%
    dplyr::group_by(municipio, virus) %>%
    dplyr::arrange(semana, .by_group = TRUE) %>%
    dplyr::slice_tail(n = 1) %>%
    dplyr::ungroup() %>%
    dplyr::mutate(
      Rt_atual = Rt,
      Interpretacao = dplyr::case_when(
        Rt_atual > 5 ~ glue(
          "Na Ãºltima semana analisada, o Rt foi de **{round(Rt_atual, 2)}**, valor muito acima de 5, ",
          "indicando transmissÃ£o extremamente intensa e crescimento explosivo dos casos desse vÃ­rus na regiÃ£o."
        ),
        Rt_atual > 2 ~ glue(
          "Na Ãºltima semana analisada, o Rt foi de **{round(Rt_atual, 2)}**, acima de 2, ",
          "o que aponta para transmissÃ£o muito intensa e rÃ¡pida expansÃ£o dos casos, compatÃ­vel com cenÃ¡rio de forte aumento da circulaÃ§Ã£o viral."
        ),
        Rt_atual > 1.05 ~ glue(
          "Na Ãºltima semana analisada, o Rt foi de **{round(Rt_atual, 2)}**, acima de 1, ",
          "sugerindo tendÃªncia de crescimento da transmissÃ£o e possibilidade de aumento de casos nas semanas seguintes se nÃ£o houver reforÃ§o nas medidas de controle."
        ),
        Rt_atual >= 0.95 & Rt_atual <= 1.05 ~ glue(
          "Na Ãºltima semana analisada, o Rt foi de **{round(Rt_atual, 2)}**, muito prÃ³ximo de 1, ",
          "indicando um quadro de estabilidade, em que o nÃºmero de novos casos tende a se manter em patamar semelhante ao das semanas anteriores."
        ),
        Rt_atual < 0.95 & Rt_atual >= 0.7 ~ glue(
          "Na Ãºltima semana analisada, o Rt foi de **{round(Rt_atual, 2)}**, abaixo de 1, ",
          "sugerindo reduÃ§Ã£o gradual da transmissÃ£o e tendÃªncia de queda lenta no nÃºmero de casos."
        ),
        Rt_atual < 0.7 ~ glue(
          "Na Ãºltima semana analisada, o Rt foi de **{round(Rt_atual, 2)}**, bem abaixo de 1, ",
          "o que indica forte reduÃ§Ã£o da transmissÃ£o e provÃ¡vel queda acentuada dos casos desse vÃ­rus na regiÃ£o."
        ),
        TRUE ~ glue(
          "Na Ãºltima semana analisada, o Rt foi de **{round(Rt_atual, 2)}**, ",
          "sem evidÃªncias de aumento importante da transmissÃ£o no perÃ­odo."
        )
      )
    ) %>%
    dplyr::select(`municipio`, VÃ­rus = virus, Interpretacao)

  cat("\n\n### Resumo por municipio â€“ Rt mais recente por vÃ­rus\n\n")

  # Se, apÃ³s filtros, nÃ£o sobrou nada:
  if (nrow(interpretacao_por_ra_virus) == 0) {
    cat(glue::glue(
      "NÃ£o foi possÃ­vel gerar interpretaÃ§Ã£o do Rt para {ano_ref} (sem estimativas vÃ¡lidas).\n"
    ))
  } else {
    knitr::kable(interpretacao_por_ra_virus, format = "pandoc", align = "l")
  }
}


```
