---
title: "Boletim epidemiolÃ³gico SRAG - SE"
author: "NVEPI Leste"  
date: "`r Sys.Date()`"
output:
  word_document:
    toc: true
    toc_depth: 2
    df_print: paged
  html_document:
    toc: true
    toc_depth: 2
    df_print: paged
    encoding: UTF-8
---

```{r setup-encoding, include=FALSE}
options(encoding = "UTF-8")
Sys.setlocale("LC_ALL", "Portuguese_Brazil.1252")  # Para Windows

dir.create("BOLETIM_SRAG_files/figure-docx", recursive = TRUE, showWarnings = FALSE)
```

```{r instalar pacotes, include=FALSE}
# Lista de pacotes CRAN
cran_packages <- c(
  "tidyverse", "lubridate", "plotly", "forecast", "EpiEstim", "DT", "officer",
  "rvg", "scales", "readxl", "purrr", "mem", "zoo", "stringi", "stringr","readxl","flextable","rmarkdown","slider","yaml","patchwork", "here"
)

# Instala apenas os pacotes que ainda nÃ£o estÃ£o instalados (usa utils:: para evitar masking)
to_install_cran <- cran_packages[!(cran_packages %in% utils::installed.packages()[, "Package"])]
if (base::length(to_install_cran) > 0) {
  utils::install.packages(to_install_cran)
}

```


```{r carregar pacotes, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
library(lubridate)
library(plotly)
library(forecast)
library(EpiEstim)
library(DT)
library(officer)
library(rvg)
library(scales)
library(readxl)
library(purrr)
library(patchwork)
library(zoo)
library(stringi)
library(stringr)
library(readxl)
library(rmarkdown)
library(flextable)
library(slider)
library(yaml)
library(glue)
library(here)

# Ancorar o root do projeto a partir deste arquivo Rmd para caminhos portÃ¡teis
# Como o arquivo estÃ¡ em SRAG/, precisamos subir um nÃ­vel para acessar Bancos/
here::i_am("SRAG/BOLETIM_SRAG.Rmd")

# Alternativa: definir diretÃ³rio de trabalho explicitamente
# setwd(dirname(here::here()))
base::cat("DiretÃ³rio de trabalho atual:", base::getwd(), "\n")
base::cat("DiretÃ³rio do arquivo Rmd:", here::here(), "\n")

# Verifica se estamos no diretÃ³rio correto
if (!base::dir.exists("Bancos")) {
  base::cat("DiretÃ³rio 'Bancos' nÃ£o encontrado no diretÃ³rio atual. Tentando mudar para o diretÃ³rio correto...\n")
  if (base::dir.exists("SRAG/Bancos")) {
    base::setwd("SRAG")
    base::cat("Mudou para o diretÃ³rio SRAG\n")
  }
}
```

```{r padronizaÃ§Ã£o}
# ðŸ”  FunÃ§Ã£o para padronizar nomes (minÃºsculo, sem acento, sem espaÃ§os)
padronizar_nomes <- function(x) {
  stringr::str_trim(stringi::stri_trans_general(stringr::str_to_lower(x), "Latin-ASCII"))
}


```


```{r Carregar bancos, include=FALSE}
# Carregar o arquivo CSV srag_min
base::cat("Carregando arquivo CSV srag_min...\n")

# Caminho para o arquivo CSV
srag_min_path <- "Bancos/srag_min.csv"

# Verifica se o arquivo existe
if (!base::file.exists(srag_min_path)) {
  base::stop("Arquivo 'srag_min.csv' nÃ£o encontrado em ", srag_min_path, ". Certifique-se de que o arquivo foi criado anteriormente.")
}

# Carrega o arquivo CSV
srag <- readr::read_csv(srag_min_path, show_col_types = FALSE)

# Cria a coluna ano a partir da coluna DT_SIN_PRI
base::cat("Criando coluna ano a partir de DT_SIN_PRI...\n")

# Verifica se a coluna DT_SIN_PRI existe
if (!"DT_SIN_PRI" %in% base::names(srag)) {
  base::stop("Coluna 'DT_SIN_PRI' nÃ£o encontrada no dataframe. Verifique se o arquivo CSV contÃ©m esta coluna.")
}

# Verifica se a coluna DT_SIN_PRI Ã© do tipo data
if (!lubridate::is.Date(srag$DT_SIN_PRI) && !lubridate::is.POSIXct(srag$DT_SIN_PRI)) {
  base::cat("Convertendo coluna DT_SIN_PRI para formato de data...\n")
  srag <- dplyr::mutate(srag, DT_SIN_PRI = lubridate::as_date(DT_SIN_PRI))
}

srag <- dplyr::mutate(srag, ano = lubridate::year(DT_SIN_PRI))

# Converte a coluna SE para inteiro se necessÃ¡rio
if ("SE" %in% base::names(srag)) {
  srag <- dplyr::mutate(srag, SE = base::as.integer(SE))
}

# Verifica se a coluna res_RS existe e filtra apenas a regiÃ£o Leste
if ("res_RS" %in% base::names(srag)) {
  base::cat("Filtrando apenas casos da regiÃ£o Leste...\n")
  srag <- dplyr::filter(srag, res_RS == "Leste")
  base::cat("Casos apÃ³s filtro da regiÃ£o Leste:", base::nrow(srag), "\n")
} else {
  base::cat("Aviso: Coluna 'res_RS' nÃ£o encontrada. Todos os casos serÃ£o incluÃ­dos.\n")
}

# Cria a coluna ID_MN_RESI_pad padronizada se ID_MN_RESI existir
if ("ID_MN_RESI" %in% base::names(srag)) {
  base::cat("Criando coluna ID_MN_RESI_pad padronizada...\n")
  srag <- dplyr::mutate(srag, ID_MN_RESI_pad = base::tolower(stringr::str_trim(ID_MN_RESI)))
} else {
  base::cat("Aviso: Coluna 'ID_MN_RESI' nÃ£o encontrada.\n")
}

base::cat("Dataframe srag carregado com", base::nrow(srag), "linhas e", base::ncol(srag), "colunas\n")
base::cat("Colunas disponÃ­veis:", base::paste(base::names(srag), collapse = ", "), "\n")
base::cat("Coluna ano criada com valores:", base::paste(base::unique(srag$ano), collapse = ", "), "\n")

# Carregar parÃ¢metros externos com fallback para caminho relativo
params_candidates <- c(
  "params.yaml",  # Caminho relativo ao diretÃ³rio atual
  here::here("params.yaml"),
  here::here("SRAG", "params.yaml"),
  "params.yaml"
)
params_path <- params_candidates[base::file.exists(params_candidates)][1]
base::cat("Arquivo de parÃ¢metros selecionado:", params_path, "\n")
if (is.na(params_path)) base::stop("Arquivo 'params.yaml' nÃ£o encontrado no projeto.")

# Verifica se o pacote yaml estÃ¡ funcionando
base::cat("Verificando pacote yaml...\n")
if (!base::require(yaml, quietly = TRUE)) {
  base::stop("Pacote yaml nÃ£o estÃ¡ disponÃ­vel")
}

base::cat("Carregando arquivo de parÃ¢metros...\n")
params_externos <- yaml::read_yaml(params_path)

filtro_ano <- params_externos$filtro_ano
ano_epidemico <- params_externos$ano_epidemico
ano_ref <- params_externos$ano_ref

# Verifica se as variÃ¡veis foram carregadas corretamente
base::cat("ParÃ¢metros carregados:\n")
base::cat("- filtro_ano:", base::paste(filtro_ano, collapse = ", "), "\n")
base::cat("- ano_epidemico:", ano_epidemico, "\n")
base::cat("- ano_ref:", ano_ref, "\n")

# Verifica se filtro_ano Ã© um vetor numÃ©rico
if (!base::is.numeric(filtro_ano) || base::length(filtro_ano) == 0) {
  base::stop("VariÃ¡vel 'filtro_ano' nÃ£o foi carregada corretamente do arquivo params.yaml")
}

# PopulaÃ§Ã£o: caminho relativo ao projeto (arquivo existe em SRAG/tabelas_auxiliares/POP.xlsx)
pop_path <- "tabelas_auxiliares/POP.xlsx"
base::cat("Verificando arquivo de populaÃ§Ã£o:", pop_path, "\n")
base::cat("Arquivo existe:", base::file.exists(pop_path), "\n")
if (!base::file.exists(pop_path)) base::stop("Arquivo de populaÃ§Ã£o nÃ£o encontrado em ", pop_path)

base::cat("Carregando arquivo de populaÃ§Ã£o...\n")
pop <- readxl::read_excel(pop_path)

# Aplica as transformaÃ§Ãµes
pop <- dplyr::rename(pop,
  ano = Ano,
  regiao = REG_ADM,
  populacao = POP
)

pop <- dplyr::mutate(pop, ID_MN_RESI_pad = padronizar_nomes(regiao))
pop <- dplyr::select(pop, ano, ID_MN_RESI_pad, populacao)
pop <- dplyr::mutate(pop, ano = base::as.double(ano))

```

```{r mapeamento viral}
# Mapeamento dos nomes dos vÃ­rus
virus_map <- c(
  PCR_FLUASU = "Influenza A",
  PCR_FLUBLI = "Influenza B",
  PCR_SARS2  = "SARS-CoV-2",
  PCR_VSR    = "VÃ­rus Sincicial RespiratÃ³rio",
  PCR_PARA1  = "Parainfluenza 1",
  PCR_PARA2  = "Parainfluenza 2",
  PCR_PARA3  = "Parainfluenza 3",
  PCR_PARA4  = "Parainfluenza 4",
  PCR_ADENO  = "AdenovÃ­rus",
  PCR_METAP  = "MetapneumovÃ­rus",
  PCR_BOCA   = "BocavÃ­rus",
  PCR_RINO   = "RinovÃ­rus",
  PCR_OUTRO  = "Outro vÃ­rus respiratÃ³rio"
)


# Ordenar idades
niveis_idade  <- c("Menor de 2","2 a 10","11 a 19","20 a 29","30 a 39",
                     "40 a 49","50 a 59","60 a 69","70 a 79","80 e mais")

```

```{r selecao-colunas-e-dataframe-reduzido, include=FALSE}
# Colunas utilizadas no boletim (fixas)
colunas_fixas_usadas <- c(
  "ID_MN_RESI", "DT_SIN_PRI", "SE", "res_RS", "NM_UN_INTE", "FE1",
  "TP_IDADE", "NU_IDADE_N", "SUPORT_VEN2", "Tempo_Evolucao", "EVOL1", "OBITOSRAG"
)

# Verifica se o dataframe srag foi carregado e tem as colunas necessÃ¡rias
if (base::exists("srag")) {
  base::cat("Dataframe srag carregado com", base::nrow(srag), "linhas\n")
  
  # Verifica se tem as colunas necessÃ¡rias
  colunas_ausentes <- base::setdiff(colunas_fixas_usadas, base::names(srag))
  if (base::length(colunas_ausentes) > 0) {
    base::cat("Colunas ausentes no srag:", base::paste(colunas_ausentes, collapse = ", "), "\n")
  } else {
    base::cat("Todas as colunas fixas estÃ£o presentes no srag\n")
  }
  
  # Identifica colunas PCR disponÃ­veis
  colunas_pcr_disponiveis <- base::grep("^PCR_", base::names(srag), value = TRUE)
  base::cat("Colunas PCR disponÃ­veis:", base::paste(colunas_pcr_disponiveis, collapse = ", "), "\n")
  
} else {
  base::stop("Dataframe srag nÃ£o encontrado. Execute primeiro o chunk 'Carregar bancos'.")
}
```

```{r casos por ano ,fig.width=9, fig.height=6, fig.cap = paste0("Figura 1 â€“ NÃºmero de casos por Semana EpidemiolÃ³gica e por ano, RegiÃ£o Leste -",base::min(filtro_ano), " a ", base::max(filtro_ano), ")"),results='asis',echo = FALSE}
      
# Verifica se a coluna ano existe
if (!"ano" %in% base::names(srag)) {
  base::stop("Coluna 'ano' nÃ£o encontrada no dataframe srag. Execute primeiro o chunk 'Carregar bancos'.")
}

df_1 <- srag %>%
  dplyr::filter(ano >= base::min(filtro_ano), ano <= base::max(filtro_ano)) %>%
  dplyr::group_by(ano, SE) %>%
  dplyr::summarise(casos = dplyr::n(), .groups = "drop") %>%
  tidyr::complete(ano, SE = 1:53, fill = list(casos = 0)) %>%
  dplyr::arrange(ano, SE) %>%
  dplyr::mutate(
    semana_id = dplyr::row_number(),  # eixo X contÃ­nuo sequencial
    ano_fator = base::factor(ano)
  ) |>
  dplyr::filter(casos > 0)

ggplot(df_1, aes(x = semana_id, y = casos)) +
  geom_col(fill = "#1f77b4", width = 0.8) +
  geom_vline(
    data = df_1 %>% group_by(ano) %>% summarise(pos = base::max(semana_id)),
    aes(xintercept = pos),
    color = "gray50", linetype = "dotted"
  ) +
  scale_x_continuous(
    breaks = df_1 %>% group_by(ano) %>% summarise(pos = base::mean(semana_id)) %>% dplyr::pull(pos),
    labels = levels(df_1$ano_fator),
    expand = c(0, 0)
  ) +
  labs(
    x = "Ano",
    y = "NÃºmero de Casos"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    axis.text.x = element_text(face = "bold", color = "black"),
    axis.title = element_text(face = "bold"),
    plot.title = element_text(face = "bold", color = "black")
  )

srag_filtrado <- srag %>% filter(ano == ano_ref)

```

```{r gerar texto grÃ¡fico 1, message=FALSE, warning=FALSE, echo = FALSE, results='asis'}
gerar_texto_ondas_srag <- function(df, anos) {
  # Verifica se tem exatamente dois anos para comparar
  if (base::length(anos) != 2) {
    base::stop("A funÃ§Ã£o requer exatamente dois anos para comparaÃ§Ã£o.")
  }
  
  df_picos <- df %>%
    filter(ano %in% anos) %>%
    group_by(ano) %>%
    summarise(
      pico = base::max(casos, na.rm = TRUE),
      semana_pico = SE[base::which.max(casos)],
      .groups = "drop"
    ) %>%
    arrange(ano)
  
  ano_1 <- df_picos$ano[1]
  ano_2 <- df_picos$ano[2]
  
  texto <- glue::glue(
    "A distribuiÃ§Ã£o semanal dos casos de SRAG na RegiÃ£o Leste entre os anos de {ano_1} e {ano_2} evidencia um padrÃ£o sazonal recorrente, ",
    "com diferenÃ§as no momento e intensidade das ondas epidÃªmicas. ",
    "Em {ano_1}, o pico de notificaÃ§Ãµes ocorreu na semana epidemiolÃ³gica {df_picos$semana_pico[1]}, com {df_picos$pico[1]} casos. ",
    "JÃ¡ em {ano_2}, o pico foi registrado na semana {df_picos$semana_pico[2]}, totalizando {df_picos$pico[2]} casos. ",
    "Essas variaÃ§Ãµes reforÃ§am a importÃ¢ncia do monitoramento contÃ­nuo para identificaÃ§Ã£o antecipada de perÃ­odos crÃ­ticos, ",
    "especialmente nos meses com maior circulaÃ§Ã£o viral."
  )
  
  return(texto)
}

texto_ondas <- gerar_texto_ondas_srag(df_1, anos = filtro_ano)
texto_ondas

```

## IncidÃªncia SRAG Ano atual

```{r incidencia atual,fig.width=9, fig.height=6, fig.cap = paste0("Figura 2 â€“ NÃºmero de casos e incidÃªncia de SRAG por 100 mil habitantes por Semana EpidemiolÃ³gica, RegiÃ£o Leste -", ano_ref, "(n = ", base::nrow(srag_filtrado), ")")}

# Calcular incidÃªncia por semana epidemiolÃ³gica
srag_inc <- srag %>%
  left_join(pop, by = c("ano", "ID_MN_RESI_pad")) %>%
  filter(!is.na(populacao), ano == ano_ref) %>%
  group_by(SE, ID_MN_RESI_pad) %>%
  summarise(
    casos = n(),
    pop = first(populacao),  # PopulaÃ§Ã£o daquele municÃ­pio no ano
    .groups = "drop"
  ) %>%
  group_by(SE) %>%
  summarise(
    casos = base::sum(casos),
    pop = base::sum(pop),
    .groups = "drop"
  ) %>%
  mutate(inc = 100000 * casos / pop)

# Ordenar o eixo X corretamente (opcional)
srag_inc$SE <- factor(srag_inc$SE, levels = base::sort(base::unique(srag_inc$SE)))

# GrÃ¡fico de colunas
ggplot(srag_inc, aes(x = SE)) +
  geom_col(aes(y = casos), fill = "#1f77b4", width = 0.8) +  # colunas de casos
  geom_line(aes(y = inc * base::max(casos) / base::max(inc)),  # linha de incidÃªncia reescalada
            color = "red", size = 1.2, group = 1) +
  scale_y_continuous(
    name = "NÃºmero de casos",
    sec.axis = sec_axis(~ . * base::max(srag_inc$inc) / base::max(srag_inc$casos),
                        name = "IncidÃªncia por 100 mil hab.")
  ) +
  labs(
    x = "Semana EpidemiolÃ³gica",
  ) +
  theme_minimal(base_size = 13) +
  theme(
    axis.title.y = element_text(color = "black", face = "bold"),
    axis.title.y.right = element_text(color = "black", face = "bold"),
    axis.text.x = element_text(face = "bold", color = "black"),
    axis.title = element_text(face = "bold"),
    plot.title = element_text(face = "bold", color = "black")
  )
```

```{r texto para o resumo tÃ©cnico, echo = FALSE, results='asis'}
gerar_texto_resumo_srag <- function(ano, total_notificacoes, media_semanal, dp_semanal, total_obitos, taxa_letalidade) {
  
  variabilidade <- case_when(
    dp_semanal < 5 ~ "baixa variabilidade na distribuiÃ§Ã£o semanal",
    dp_semanal < 15 ~ "moderada variabilidade na distribuiÃ§Ã£o semanal",
    TRUE ~ "alta variabilidade na distribuiÃ§Ã£o semanal"
  )
  
  texto <- glue::glue(
    "Em {ano}, foram notificados {total_notificacoes} casos de SÃ­ndrome RespiratÃ³ria Aguda Grave (SRAG), ",
    "com uma mÃ©dia de {round(media_semanal, 1)} casos por semana epidemiolÃ³gica e um desvio padrÃ£o de {round(dp_semanal, 1)}, ",
    "indicando {variabilidade} dos casos ao longo do ano. ",
    if (total_obitos == 0) {
      "NÃ£o foram registrados Ã³bitos por SRAG no perÃ­odo, o que sugere um perfil de casos nÃ£o graves em 2025."
    } else if (total_obitos == 1) {
      "Observou-se um Ãºnico Ã³bito atribuÃ­do Ã  SRAG, resultando em uma taxa de letalidade de {round(taxa_letalidade, 1)}%,"
      "o que sugere um perfil de casos predominantemente nÃ£o graves no perÃ­odo avaliado."
    } else {
      "Foram registrados {total_obitos} Ã³bitos, com uma taxa de letalidade de {round(taxa_letalidade, 1)}%, "
      "refletindo a presenÃ§a de casos com maior gravidade."
    },
    " A baixa letalidade e o padrÃ£o de notificaÃ§Ãµes observados reforÃ§am a importÃ¢ncia da manutenÃ§Ã£o da vigilÃ¢ncia epidemiolÃ³gica ativa."
  )
  
  return(texto)
}
```

```{r resumo_situacao, echo=FALSE, results='asis'}
# Filtro do ano de interesse


# Total de notificaÃ§Ãµes
total_notificacoes <- base::nrow(srag_filtrado)

# Casos por semana
casos_semanal <- srag_filtrado %>%
  group_by(SE) %>%
  summarise(casos = n(), .groups = "drop")

# MÃ©dia e desvio padrÃ£o
media_casos <- mean(casos_semanal$casos, na.rm = TRUE)
dp_casos <-sd(casos_semanal$casos, na.rm = TRUE)

# Total de Ã³bitos
total_obitos <- base::sum(srag_filtrado$OBITOSRAG == "Sim", na.rm = TRUE)

# Taxa de letalidade (%)
taxa_letalidade <- (total_obitos / total_notificacoes) * 100

# Exibir resumo
tibble::tibble(
  `Total de notificaÃ§Ãµes` = total_notificacoes,
  `MÃ©dia semanal de casos` = round(media_casos, 1),
  `Desvio padrÃ£o semanal` = round(dp_casos, 1),
  `Total de Ã³bitos` = total_obitos,
  `Taxa de letalidade (%)` = round(taxa_letalidade, 1)
) %>%
  knitr::kable(caption = paste("Resumo da SituaÃ§Ã£o EpidemiolÃ³gica â€“", ano_ref))

texto_srag <- gerar_texto_resumo_srag(
  ano = ano_ref,
  total_notificacoes = total_notificacoes,
  media_semanal = media_casos,
  dp_semanal = dp_casos,
  total_obitos = total_obitos,
  taxa_letalidade = taxa_letalidade
)

texto_srag
```



## VÃ­rus detectados

```{r virus detectados, fig.width=9, fig.height=6,fig.height=6, fig.cap = paste0("Figura 3 â€“ ProporÃ§Ã£o de vÃ­rus detectados de SRAG, RegiÃ£o Leste -", ano_ref, "(n = ", sum(df_tot$casos), ")")}
cols_pcr <- names(virus_map)

df_tot <- srag %>%
  filter(ano == ano_ref) %>%
  select(all_of(cols_pcr)) %>%
  pivot_longer(cols = everything(), names_to = "virus", values_to = "valor") %>%
  filter(valor == 1) %>%
  mutate(virus = virus_map[virus]) %>%
  count(virus, name = "casos") %>%
  mutate(
    percentual = casos / base::sum(casos) * 100,
    virus = fct_reorder(virus, casos)  # ordena pelo total
  )

ggplot(df_tot, aes(x = virus, y = casos)) +
  geom_col(fill = "#4E79A7") +
  geom_text(
    aes(label = paste0(casos, " (", round(percentual, 1), "%)")),
    vjust = -0.3, size = 5
  ) +
  labs(
    title = paste("ProporÃ§Ã£o de DetecÃ§Ã£o por VÃ­rus (PCR+), RegiÃ£o Leste,", ano_ref),
    x = "Tipo de VÃ­rus",
    y = "NÃºmero de Registros"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(face = "bold")
  )




```

```{r texto para tipos de vÃ­rus,  echo = FALSE, results='asis'}
gerar_texto_pcr_virus <- function(df_tot, ano) {
  df_ord <- df_tot %>% arrange(desc(casos))
  
  top1 <- df_ord$virus[1]
  top2 <- df_ord$virus[2]
  top3 <- df_ord$virus[3]
  
  pct1 <- round(df_ord$percentual[1], 1)
  pct2 <- round(df_ord$percentual[2], 1)
  pct3 <- round(df_ord$percentual[3], 1)
  
  texto <- glue::glue(
    "Em {ano}, entre os casos com detecÃ§Ã£o positiva por PCR na RegiÃ£o Leste, ",
    "o {top1} foi o agente mais frequente, representando {pct1}% dos registros. ",
    "Em seguida, destacaram-se o {top2} ({pct2}%) e o {top3} ({pct3}%). ",
    "Os demais vÃ­rus apresentaram participaÃ§Ã£o minoritÃ¡ria no total de detecÃ§Ãµes. ",
    "Esses dados reforÃ§am o papel dominante do {top1} na circulaÃ§Ã£o viral respiratÃ³ria ",
    "durante o ano, com evidÃªncia de cocirculaÃ§Ã£o de mÃºltiplos agentes etiolÃ³gicos."
  )
  
  return(texto)
}
texto_pcr <- gerar_texto_pcr_virus(df_tot, ano = ano_ref)
texto_pcr

```

## Tipo de vÃ­rus por Semana EpidemiolÃ³gica

```{r virus por SE, fig.width=9, fig.height=6,fig.height=6, fig.cap = paste0("Figura 4 â€“ ProporÃ§Ã£o de vÃ­rus detectados no PCR de SRAG por semana epidemiolÃ³gica, RegiÃ£o Leste -", ano_ref, "(n = ", base::sum(df_week$casos), ")")}
 cols_pcr <- names(virus_map)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1. Base de casos positivos por Semana EpidemiolÃ³gica (SE) e vÃ­rus
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
df_week <- srag %>%                                         # base original
  filter(ano == ano_ref) %>%                                # ano de interesse
  select(SE, all_of(cols_pcr)) %>%                         # colunas PCR (0/1)
  mutate(SE = as.integer(SE)) %>%                          # garantir inteiro
  pivot_longer(cols = -SE,
               names_to = "virus",
               values_to = "valor") %>%                    # formato longo
  filter(valor == 1) %>%                                   # apenas positivos
  mutate(virus_nome = virus_map[virus]) %>%                # rÃ³tulo compreensÃ­vel
  group_by(SE, virus_nome) %>%                             # contar por SE-vÃ­rus
  summarise(casos = n(), .groups = "drop")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2. ProporÃ§Ã£o global do ano (para exibir na legenda)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
proporcoes <- df_week %>%
  group_by(virus_nome) %>%
  summarise(total = sum(casos), .groups = "drop") %>%
  mutate(percentual = total / base::sum(total) * 100,
         virus_legenda = paste0(virus_nome,
                                " (", round(percentual, 1), "%)"))

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3. Juntar proporÃ§Ã£o global na base principal
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
df_week <- df_week %>%
  left_join(proporcoes, by = "virus_nome")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 4. Calcular proporÃ§Ã£o semanal para grÃ¡fico 100 % empilhado
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
df_week_prop <- df_week %>%
  group_by(SE) %>%
  mutate(prop = casos / base::sum(casos)) %>%    # proporÃ§Ã£o na semana
  ungroup()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 5. GrÃ¡fico 100 % empilhado
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ggplot(df_week_prop,
       aes(x = SE,
           y = prop,
           fill = virus_legenda)) +

  geom_col(width = 0.95) +  # barras empilhadas
  scale_y_continuous(labels = percent_format(accuracy = 1)) +  # eixo em %
  scale_fill_brewer(palette = "Set3") +  # nova paleta

  labs(
    x = "Semana EpidemiolÃ³gica",
    y = "ProporÃ§Ã£o de VÃ­rus (%)",
    fill = "Tipo de VÃ­rus\n(participaÃ§Ã£o no ano)"
  ) +

  theme_minimal(base_size = 13) +
  theme(
    legend.title = element_text(face = "bold"),
    legend.text  = element_text(size = 9),
    axis.text.x  = element_text(angle = 45, hjust = 1)
  )





```

```{r  echo = FALSE, results='asis'}
gerar_texto_virus_temporal <- function(df_week, proporcoes, ano) {
  total_semanas <- base::length(base::unique(df_week$SE))
  
  virus_top <- proporcoes %>%
    arrange(desc(percentual)) %>%
    slice_head(n = 2)
  
  pico_semana <- df_week %>%
    group_by(SE) %>%
    summarise(total = base::sum(casos)) %>%
    slice_max(order_by = total, n = 1)
  
  texto <- glue::glue(
    "A anÃ¡lise da circulaÃ§Ã£o viral ao longo das semanas epidemiolÃ³gicas de {ano} mostra um padrÃ£o sazonal concentrado entre as semanas ",
    "{base::min(df_week$SE)} e {base::max(df_week$SE)}, com pico de detecÃ§Ãµes na semana {pico_semana$SE}, totalizando {pico_semana$total} registros. ",
    "O {virus_top$virus_nome[1]} foi o agente predominante, seguido por {virus_top$virus_nome[2]}. ",
    "Ambos apresentaram circulaÃ§Ã£o acentuada durante o perÃ­odo epidÃªmico, sugerindo cocirculaÃ§Ã£o. ",
    "Demais vÃ­rus, como os identificados por menor proporÃ§Ã£o, tiveram presenÃ§a limitada. ",
    "Esse comportamento reforÃ§a a importÃ¢ncia do monitoramento laboratorial contÃ­nuo para antecipaÃ§Ã£o de surtos e gestÃ£o de resposta em saÃºde pÃºblica."
  )
  
  return(texto)
}
texto_temporal <- gerar_texto_virus_temporal(df_week, proporcoes, ano = ano_ref)
texto_temporal
```

## HospitalizaÃ§Ãµes



```{r hospitalizacoes, fig.width=9, fig.height=6,fig.cap = paste0("Figura 5 â€“ NÃºmero de hospitalizaÃ§Ãµes de casos de SRAG por hospital, RegiÃ£o Leste -", ano_ref, "(n = ", total_notificacoes, ")")}

df_13 <- srag %>%
  filter(!is.na(NM_UN_INTE), ano == ano_ref) %>%
  group_by(NM_UN_INTE) %>%
  summarise(casos = n(), .groups = "drop")

ggplot(df_13, aes(x = casos, y = reorder(NM_UN_INTE, casos))) +
  geom_col(fill = "forestgreen", alpha = 0.7) +
  labs(
    x = "Casos",
    y = "Unidade"
  ) +
  theme_minimal(base_size = 12) +
  theme(axis.text.y = element_text(size = 10))



```

```{r Texto hospitalizacoes, echo = FALSE,results='asis'}
gerar_texto_hospitalizacoes <- function(df_unidades, ano) {
  total <- base::sum(df_unidades$casos)
  
  df_top <- df_unidades %>%
    arrange(desc(casos)) %>%
    slice(1:2) %>%
    mutate(percentual = round(casos / total * 100, 1))
  
  texto <- glue::glue(
    "Em {ano}, as hospitalizaÃ§Ãµes por SRAG na RegiÃ£o Leste concentraram-se majoritariamente em poucas unidades de saÃºde. ",
    "O destaque absoluto foi o {df_top$NM_UN_INTE[1]}, responsÃ¡vel por aproximadamente {df_top$percentual[1]}% de todas as internaÃ§Ãµes no perÃ­odo. ",
    "Na sequÃªncia, o {df_top$NM_UN_INTE[2]} tambÃ©m apresentou volume expressivo de hospitalizaÃ§Ãµes, com {df_top$percentual[2]}% dos casos. ",
    "As demais unidades registraram quantitativos inferiores, muitas com menos de 5 registros. ",
    "Esse padrÃ£o evidencia a centralizaÃ§Ã£o da assistÃªncia hospitalar em unidades especÃ­ficas, possivelmente relacionada Ã  capacidade instalada, ",
    "perfil populacional atendido ou Ã  definiÃ§Ã£o regional de referÃªncia para SRAG."
  )
  
  return(texto)
}

texto_hospitais <- gerar_texto_hospitalizacoes(df_13, ano = ano_ref)
texto_hospitais

```

## Faixa etÃ¡ria


```{r faixa etaria, fig.width=9, fig.height=6,fig.cap = paste0("Figura 6 â€“ ProporÃ§Ã£o casos de SRAG por faixa etÃ¡ria, RegiÃ£o Leste -", ano_ref, "(n = ", base::sum(df_week$casos), ")")}
df_2 <- srag %>%
      filter(!is.na(FE1) & ano == ano_ref) %>%
      mutate(FE1 = factor(FE1, levels = niveis_idade)) %>%
      group_by(FE1) %>%
      summarise(casos = n(), .groups = "drop") %>%
      mutate(percentual = round(casos / sum(casos) * 100, 1))

# Criar grÃ¡fico de faixa etÃ¡ria

  ggplot(df_2, aes(x = FE1, y = casos)) +
      geom_col(fill = "#4E79A7") +
      geom_text(aes(label = paste0(percentual, "%")),
                position = position_stack(vjust = 0.5), size = 5) +
      labs(x = "Faixa EtÃ¡ria", y = "Casos") +
      theme_minimal() +
      theme(legend.position = "none",
            axis.text.x = element_text(angle = 45, hjust = 1))
  
  

```

```{r Texto faixa etaria, echo = FALSE,results='asis'}
gerar_texto_faixa_etaria <- function(df_faixa, ano) {
  total <- sum(df_faixa$casos)
  
  top2 <- df_faixa %>%
    arrange(desc(casos)) %>%
    slice(1:2)
  
  soma_top2 <- sum(top2$percentual)
  
  idosos <- df_faixa %>%
    filter(FE1 %in% c("70 a 79", "80 ou mais")) %>%
    summarise(pct_idoso = sum(percentual)) %>%
    dplyr::pull(pct_idoso)
  
  texto <- glue::glue(
    "Em {ano}, a anÃ¡lise da distribuiÃ§Ã£o etÃ¡ria dos casos de SRAG na RegiÃ£o Leste evidencia um perfil predominantemente pediÃ¡trico. ",
    "Cerca de {top2$percentual[1]}% dos registros ocorreram em {top2$FE1[1]}, enquanto {top2$percentual[2]}% concentraram-se em {top2$FE1[2]}. ",
    "Juntas, essas duas faixas etÃ¡rias representaram mais de {soma_top2}% do total de notificaÃ§Ãµes. ",
    "As demais faixas apresentaram percentuais reduzidos, com idosos acima de 70 anos representando {idosos}% dos casos. ",
    "Esse padrÃ£o reforÃ§a a importÃ¢ncia da vigilÃ¢ncia ativa em populaÃ§Ãµes infantis, especialmente nos perÃ­odos sazonais de maior circulaÃ§Ã£o viral."
  )
  
  return(texto)
}

texto_faixa <- gerar_texto_faixa_etaria(df_2, ano = ano_ref)
texto_faixa

```

## Menores de 2 anos



```{r proporcao_bebes,fig.width=9, fig.height=6,fig.cap = paste0("Figura 7 â€“ ProporÃ§Ã£o casos de SRAG por de bebÃªs menores de 1 ano por mÃªs e dias de vida, RegiÃ£o Leste -", ano_ref, "(n = ", sum(df_week$casos), ")")}
# Filtrar apenas bebÃªs com idade em dias (1) ou meses (2) e vÃ­rus positivo
df_3 <- srag %>%
  filter(TP_IDADE %in% c(1, 2), ano == ano_ref) %>%
  select(TP_IDADE, NU_IDADE_N, starts_with("PCR_")) %>%
  pivot_longer(cols = starts_with("PCR_"),
               names_to = "virus_codigo",
               values_to = "positivo") %>%
  filter(positivo == 1) %>%
  mutate(
    Tipo = case_when(
      TP_IDADE == 1 ~ "Dias",
      TP_IDADE == 2 ~ "Meses"
    ),
    virus_nome = virus_map[virus_codigo],
    virus_nome = iconv(virus_nome, from = "", to = "UTF-8")  # <-- aqui!
  ) %>%
  drop_na(virus_nome)


# Calcular proporÃ§Ã£o por idade e tipo
df_3_prop <- df_3 %>%
  group_by(Tipo, NU_IDADE_N) %>%
  summarise(n = n(), .groups = "drop") %>%
  group_by(Tipo) %>%
  mutate(prop = n / sum(n)) %>%
  ungroup()

ggplot(df_3_prop, aes(x = NU_IDADE_N, y = prop)) +
  geom_col(fill = "steelblue") +
  geom_text(aes(label = scales::percent(prop, accuracy = 0.1)),
            vjust = -0.3, size = 4) +
  facet_wrap(~Tipo, scales = "free") +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(
    x = "Idade",
    y = "ProporÃ§Ã£o de casos"
  ) +
  theme_minimal()



```

```{r Texto menores de 2 anos, echo = FALSE,results='asis' }
gerar_texto_srag_bebes <- function(df_3_prop, ano) {
  pico_dias <- df_3_prop %>%
    filter(Tipo == "Dias") %>%
    slice_max(prop, n = 1)
  
  pico_meses <- df_3_prop %>%
    filter(Tipo == "Meses") %>%
    slice_max(prop, n = 1)
  
  texto <- glue::glue(
    "A anÃ¡lise dos casos de SRAG com detecÃ§Ã£o viral entre bebÃªs na RegiÃ£o Leste, em {ano}, revela um padrÃ£o de maior concentraÃ§Ã£o ",
    "nas faixas etÃ¡rias mais precoces. Entre os recÃ©m-nascidos com idade registrada em dias, destaca-se um pico de casos aos ",
    "{pico_dias$NU_IDADE_N} dias de vida, responsÃ¡vel por {scales::percent(pico_dias$prop, accuracy = 0.1)} das notificaÃ§Ãµes desse subgrupo. ",
    "JÃ¡ entre os lactentes com idade expressa em meses, observa-se maior proporÃ§Ã£o de casos aos {pico_meses$NU_IDADE_N} mÃªs(es), representando ",
    "{scales::percent(pico_meses$prop, accuracy = 0.1)} das ocorrÃªncias. ",
    "Esse perfil reforÃ§a a vulnerabilidade imunolÃ³gica dos menores de 6 meses frente aos vÃ­rus respiratÃ³rios e destaca a importÃ¢ncia ",
    "de estratÃ©gias de proteÃ§Ã£o especÃ­ficas para essa faixa etÃ¡ria, como o monitoramento da circulaÃ§Ã£o viral, vacinaÃ§Ã£o de contatos ",
    "e fortalecimento da vigilÃ¢ncia laboratorial."
  )
  
  return(texto)
}

texto_bebes <- gerar_texto_srag_bebes(df_3_prop, ano = ano_ref)
texto_bebes
```



```{r virus por bebes, fig.width=9, fig.height=6,fig.cap = paste0("Figura 8 â€“ ProporÃ§Ã£o casos de SRAG por de bebÃªs menores de 1 ano por mÃªs e dias de vida e tipo de vÃ­rus detectados, RegiÃ£o Leste -", ano_ref, "(n = ", total_notificacoes, ")")}
# 1. Calcular proporÃ§Ãµes
df_3_prop <- df_3 %>%
  count(Tipo, NU_IDADE_N, virus_nome, name = "n") %>%
  group_by(Tipo, NU_IDADE_N) %>%
  mutate(prop = n / sum(n)) %>%
  ungroup()


# 2. GrÃ¡fico empilhado 100%
ggplot(df_3_prop, aes(x = NU_IDADE_N, y = prop, fill = virus_nome)) +
  geom_col(position = "fill") +
  facet_wrap(~Tipo, scales = "free") +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(
    x = "Idade",
    y = "ProporÃ§Ã£o (%)",
    fill = "VÃ­rus detectado"
  ) +
  theme_minimal() +
  theme(
    legend.title = element_text(face = "bold"),
    legend.text = element_text(size = 9),
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
  scale_fill_brewer(palette = "Set3")  # ou substitua por viridis/metbrewer






```

```{r Texto v[irus bebes], echo= FALSE,results='asis'}
df_virus <- df_3 %>%
  filter(!is.na(virus_nome)) %>%
  count(virus_nome, name = "n")

gerar_texto_virus_bebes <- function(df_virus, ano) {
  top_virus <- df_virus %>%
    group_by(virus_nome) %>%
    summarise(total = sum(n), .groups = "drop") %>%
    arrange(desc(total)) %>%
    slice(1:3)
  
  texto <- glue::glue(
    "A anÃ¡lise da distribuiÃ§Ã£o de vÃ­rus respiratÃ³rios entre bebÃªs com SRAG na RegiÃ£o Leste, em {ano}, mostra que o {top_virus$virus_nome[1]} foi o agente predominante ",
    "em praticamente todas as faixas etÃ¡rias avaliadas, especialmente nos primeiros meses de vida. ",
    "O {top_virus$virus_nome[2]} aparece como o segundo agente mais frequente, com detecÃ§Ãµes dispersas entre os meses iniciais. ",
    "O {top_virus$virus_nome[3]} teve menor participaÃ§Ã£o, mas esteve presente em vÃ¡rias faixas etÃ¡rias. ",
    "Esse padrÃ£o reforÃ§a o papel central do {top_virus$virus_nome[1]} nas hospitalizaÃ§Ãµes de bebÃªs, ",
    "ressaltando a importÃ¢ncia de aÃ§Ãµes preventivas especÃ­ficas como imunizaÃ§Ã£o materna e medidas de proteÃ§Ã£o precoce."
  )
  
  return(texto)
}

texto_virus_bebes <- gerar_texto_virus_bebes(df_virus, ano = ano_ref)
texto_virus_bebes
```
## Uso de ventilaÃ§Ã£o

```{r ventilacao, fig.width=9, fig.height=6,fig.cap = paste0("Figura 9 â€“ ProporÃ§Ã£o casos de SRAG por uso de suporte ventilatÃ³rio, RegiÃ£o Leste -", ano_ref, "(n = ", total_notificacoes, ")")}
 df_4 <- srag %>%
   filter(ano == ano_ref, !is.na(SUPORT_VEN2)) |>
      count(SUPORT_VEN2) %>%
      rename(casos = n) %>%
      mutate(percentual = round(casos / sum(casos) * 100, 1))
    
  ggplot(df_4, aes(x = SUPORT_VEN2, y = casos)) +
      geom_col(fill = "#E15759") +
      geom_text(aes(label = paste0(percentual, "%")),
                position = position_stack(vjust = 0.5), size = 5) +
      labs(x = "Tipo de Suporte", y = "Casos") +
      theme_minimal() +
      theme(axis.text.x = element_text(angle = 45, hjust = 1),
            legend.position = "none")
  
  

    
```

```{r Texto ventilacao, echo = FALSE,results='asis'}
gerar_texto_suporte_ventilatorio <- function(df_4, ano) {
  df_ord <- df_4 %>% arrange(desc(casos))
  
  suporte1 <- df_ord$SUPORT_VEN2[1]
  pct1     <- df_ord$percentual[1]
  
  suporte2 <- df_ord$SUPORT_VEN2[2]
  pct2     <- df_ord$percentual[2]
  
  suporte3 <- df_ord$SUPORT_VEN2[3]
  pct3     <- df_ord$percentual[3]
  
  texto <- glue::glue(
    "Em {ano}, entre os casos de SRAG internados na RegiÃ£o Leste, observou-se que a maioria dos pacientes ({pct1}%) recebeu {tolower(suporte1)}, ",
    "seguido por {pct2}% que necessitaram de {tolower(suporte2)}. ",
    "Apenas {pct3}% dos pacientes nÃ£o utilizaram suporte ventilatÃ³rio. ",
    "Esse padrÃ£o sugere uma carga significativa de casos graves, com demanda elevada por suporte respiratÃ³rio, ",
    "reforÃ§ando a importÃ¢ncia do preparo da rede assistencial em perÃ­odos epidÃªmicos."
  )
  
  return(texto)
}

texto_ventilacao <- gerar_texto_suporte_ventilatorio(df_4, ano = ano_ref)
texto_ventilacao

```

## Ã“bitos


```{r obitos, fig.width=9, fig.height=6,fig.cap = paste0("Figura 10 â€“ NÃºmero de Ã³bitos por SRAG por semana epidmeiolÃ³gica, RegiÃ£o Leste -", ano_ref, "(n = ", sum(df_5$obitos), ")")}
df_5 <- srag%>%
  filter(ano == ano_ref) |>
      group_by(ano, SE) %>%
      summarise(obitos = sum(OBITOSRAG == "Sim", na.rm = TRUE), .groups = "drop")
  
   ggplot(df_5, aes(x =SE, y = obitos)) +
      geom_col(fill = "red") +
      labs( x = "Ano", y = "Ã“bitos") +
      theme_minimal()
  # Tabela com SE, vÃ­rus, faixa etÃ¡ria e nÃºmero de Ã³bitos
tabela_obitos <- srag %>%
  filter(OBITOSRAG == "Sim", !is.na(FE1), ano == ano_ref) %>%
  select(SE,ID_MN_RESI_pad ,FE1, starts_with("PCR_")) %>%
  pivot_longer(cols = starts_with("PCR_"),
               names_to = "virus_codigo",
               values_to = "positivo") %>%
  filter(positivo == 1) %>%
  mutate(
    virus_nome = virus_map[virus_codigo],
    virus_nome = iconv(virus_nome, from = "", to = "UTF-8"),
    FE1 = factor(FE1, levels = niveis_idade),
    Regiao_Administrativa = as.factor(ID_MN_RESI_pad)
  ) %>%
  drop_na(virus_nome) %>%
  group_by(SE, virus_nome, FE1,Regiao_Administrativa) %>%
  summarise(obitos = n(), .groups = "drop")

# Exibir a tabela (em HTML)
if (knitr::is_html_output()) {
  DT::datatable(
    tabela_obitos,
    caption = "Ã“bitos por Semana EpidemiolÃ³gica, Tipo de VÃ­rus e Faixa EtÃ¡ria",
    rownames = FALSE,
    options = list(pageLength = 10, scrollX = TRUE)
  )
} else {
  knitr::kable(
    tabela_obitos,
    caption = "Ã“bitos por Semana EpidemiolÃ³gica, Tipo de VÃ­rus e Faixa EtÃ¡ria"
  )
}



```

```{r Texto obitos, echo = FALSE,results='asis'}
gerar_texto_obitos_semanal <- function(df_obitos, ano) {
  total <- sum(df_obitos$obitos, na.rm = TRUE)
  
  if (total == 0) {
    return(glue::glue(
      "Em {ano}, nÃ£o foram registrados Ã³bitos por SRAG na RegiÃ£o Leste. ",
      "Esse cenÃ¡rio de ausÃªncia de letalidade sugere uma predominÃ¢ncia de casos clÃ­nicos leves ou manejo eficaz dos pacientes internados. ",
      "Apesar disso, a vigilÃ¢ncia contÃ­nua segue sendo essencial para resposta rÃ¡pida a qualquer mudanÃ§a no padrÃ£o de gravidade."
    ))
  } else {
    semana <- df_obitos %>% filter(obitos > 0) %>% dplyr::pull(SE)
    return(glue::glue(
      "Em {ano}, foi registrado apenas um Ã³bito por SRAG na RegiÃ£o Leste, concentrado na semana epidemiolÃ³gica {semana}. ",
      "A ausÃªncia de novos registros nas semanas seguintes indica um cenÃ¡rio de baixa letalidade no perÃ­odo avaliado, ",
      "reforÃ§ando a importÃ¢ncia de manter a vigilÃ¢ncia ativa e o monitoramento contÃ­nuo de complicaÃ§Ãµes."
    ))
  }
}

texto_obitos <- gerar_texto_obitos_semanal(df_5, ano = ano_ref)
texto_obitos


```

## InternaÃ§Ã£o por faixa etÃ¡ria

```{r internacao, fig.width=9, fig.height=6,fig.cap = paste0("Figura 11 â€“ Tempo de internaÃ§Ã£o (em dias) por faixa etÃ¡ria, RegiÃ£o Leste -", ano_ref, "(n = ", total_notificacoes, ")")}
df_6 <- srag %>%
      filter(!is.na(Tempo_Evolucao), !is.na(FE1), ano == ano_ref) %>%
      # garante a ordem correta das faixas
      mutate(FE1 = factor(FE1, levels = niveis_idade))
    
  ggplot(df_6, aes(x = FE1, y = Tempo_Evolucao)) +
      geom_boxplot(fill = "#59A14F") +
      labs(
        title = paste("Tempo de InternaÃ§Ã£o (dias) por Faixa EtÃ¡ria",ano_ref),
        x     = "Faixa EtÃ¡ria",
        y     = "Dias"
      ) +
      theme_minimal() +
      theme(axis.text.x = element_text(angle = 45, hjust = 1))
  
  

```

```{r Texto faixa etaria e tempo de internacao, echo = FALSE,results='asis'}
gerar_texto_tempo_internacao <- function(df_6, ano) {
  # Medianas por faixa etÃ¡ria
  resumo <- df_6 %>%
    group_by(FE1) %>%
    summarise(mediana = median(Tempo_Evolucao, na.rm = TRUE), .groups = "drop") %>%
    arrange(desc(mediana))
  
  faixa_top1 <- resumo$FE1[1]
  med_top1   <- resumo$mediana[1]
  
  faixa_top2 <- resumo$FE1[2]
  med_top2   <- resumo$mediana[2]
  
  faixa_inf <- resumo %>%
    filter(FE1 %in% c("Menor de 2", "2 a 10")) %>%
    summarise(mediana = base::round(base::mean(mediana, na.rm = TRUE), 1)) %>%
    dplyr::pull(mediana)
  
  texto <- glue::glue(
    "Em {ano}, a anÃ¡lise da duraÃ§Ã£o das internaÃ§Ãµes por SRAG na RegiÃ£o Leste revelou diferenÃ§as expressivas entre as faixas etÃ¡rias. ",
    "Pacientes com {faixa_top1} apresentaram os maiores tempos de internaÃ§Ã£o, com mediana de aproximadamente {med_top1} dias, ",
    "seguido pelo grupo de {faixa_top2}, com {med_top2} dias. ",
    "JÃ¡ entre crianÃ§as menores de 10 anos, as internaÃ§Ãµes foram significativamente mais curtas, com mediana mÃ©dia de {faixa_inf} dias. ",
    "Esses achados destacam a maior complexidade clÃ­nica entre adultos e idosos, com impacto direto na carga assistencial e uso prolongado de leitos hospitalares."
  )
  
  return(texto)
}
texto_internacao <- gerar_texto_tempo_internacao(df_6, ano = ano_ref)
texto_internacao
```

## EvoluÃ§Ã£o

```{r evolucao, fig.width=9, fig.height=6,fig.cap = paste0("Figura 12 â€“ ProporÃ§Ã£o de casos de SRAG segundo evoluÃ§Ã£o, RegiÃ£o Leste -", ano_ref, "(n = ", total_notificacoes, ")")}
df_9 <- srag%>%
      filter(!is.na(EVOL1), ano == ano_ref) %>%
      group_by(EVOL1) %>% summarise(casos=n(), .groups="drop") |>
      mutate(percentual = round(casos / sum(casos) * 100, 1))

  ggplot(df_9, aes(x=reorder(EVOL1, casos), y=casos)) +
      geom_col(fill="#F28E2B") +
    geom_text(aes(label = paste0(percentual, "%")),
                position = position_stack(vjust = 0.5), size = 5) +
      labs(title=paste("Percentual de internaÃ§Ã£o por tipo de evoluÃ§Ã£o na RegiÃ£o Leste",ano_ref), x="Desfecho", y="Casos") +
      theme_minimal() + theme(legend.position="none")
  


```

```{r TEXTO EVOLUCAO, echo = FALSE,results='asis'}
gerar_texto_evolucao <- function(df_9, ano) {
  df_ordenado <- df_9 %>% arrange(desc(casos))
  
  cura_pct <- df_ordenado %>% filter(grepl("Cura", EVOL1)) %>% dplyr::pull(percentual)
  ignorado_pct <- df_ordenado %>% filter(grepl("Ignorado", EVOL1)) %>% dplyr::pull(percentual)
  obito_srag <- df_ordenado %>% filter(grepl("^Ã“bito$", EVOL1)) %>% dplyr::pull(percentual)
  obito_outros <- df_ordenado %>% filter(grepl("outras causas", EVOL1)) %>% dplyr::pull(percentual)
  
  texto <- glue::glue(
    "Em {ano}, a maioria dos casos internados por SRAG na RegiÃ£o Leste evoluiu para cura, representando {cura_pct}% dos registros com desfecho informado. ",
    "Cerca de {ignorado_pct}% dos casos permaneceram com evoluÃ§Ã£o ignorada, o que indica ausÃªncia de encerramento adequado no sistema. ",
    "A letalidade observada foi baixa: {obito_srag}% dos casos evoluÃ­ram para Ã³bito por SRAG, e {obito_outros}% para Ã³bito por outras causas. ",
    "Enquanto a alta proporÃ§Ã£o de cura aponta para um manejo clÃ­nico eficaz, a presenÃ§a significativa de registros ignorados evidencia a importÃ¢ncia de fortalecer a vigilÃ¢ncia e qualificaÃ§Ã£o dos dados de encerramento."
  )
  
  return(texto)
}

  texto_evolucao <- gerar_texto_evolucao(df_9, ano = ano_ref)
texto_evolucao

```

# Diagrama de controle de SRAG 

```{r diagrama de controle Leste, fig.width=9, fig.height=6,fig.cap = paste0("Figura 13 â€“ Diagrama de controle de SRAG por semana epidmeiolÃ³gica, RegiÃ£o Leste -", ano_ref, ".")}
anos_hist <- (ano_ref - 10):(ano_ref - 1)

# Juntar com populaÃ§Ã£o correta
df_10 <- srag %>%
  left_join(pop, by = c("ano", "ID_MN_RESI_pad")) %>%
  filter(!is.na(populacao)) %>%
  mutate(incidencia = 100000 / populacao)  # 1 caso por linha

# HistÃ³rico
historico <- df_10 %>%
   filter(ano %in% anos_hist, !ano %in% ano_epidemico) %>%
  group_by(SE, ano) %>%
  summarise(casos = n(), pop = populacao, .groups = "drop") %>%
  mutate(inc = 100000 * casos / pop)

limiares <- historico %>%
  group_by(SE) %>%
  summarise(
    media = base::mean(inc),
    sd = sd(inc),
    lim_1 = media + sd,
    lim_2 = media + 2 * sd,
    lim_3 = media + 3 * sd,
    .groups = "drop"
  )

# Dados atuais (ano de referÃªncia)
atual <- df_10 %>%
  filter(ano == ano_ref) %>%
  group_by(SE) %>%
  summarise(casos = n(), pop = first(populacao), .groups = "drop") %>%
  mutate(inc = 100000 * casos / pop)


#Nowcasting dos casos

# Calcular a mÃ©dia mÃ³vel (lag = 1, para nÃ£o usar valores futuros)
atual <- atual %>%
  arrange(SE) %>%
  mutate(
    inc_ma = rollmean(inc, k = 4, align = "right", fill = NA)
  )

# Ãšltima SE registrada no ano de referÃªncia
ultima_SE <- base::max(atual$SE, na.rm = TRUE)

# Fator de correÃ§Ã£o fixo (exemplo: 1.2). VocÃª pode usar um nowcast_fator se quiser.
fator_nowcasting <- 1.2

# Corrigir nas 4 Ãºltimas semanas com base na mÃ©dia mÃ³vel
nowcast <- atual %>%
  filter(SE >= (ultima_SE - 8), SE <= ultima_SE-1) %>%
  mutate(
    inc_corrigida = inc_ma,
    ic_low = inc_corrigida * 0.9,
    ic_up  = inc_corrigida * 1.1
  ) %>%
  drop_na(inc_corrigida)


# GrÃ¡fico
# ðŸ–¼ GrÃ¡fico com legenda
caption_text <- paste0(
  "Anos de referÃªncia para os limiares ", 
  base::min(filtro_ano), " a ", base::max(filtro_ano), 
  ". Retirando o ano epidÃªmico de:", ano_epidemico
)

ggplot() +
  geom_ribbon(data = limiares, aes(x = SE, ymin = 0, ymax = media, fill = "Zona de controle"), alpha = 0.3) +
  geom_ribbon(data = limiares, aes(x = SE, ymin = media, ymax = lim_1, fill = "Zona de seguranÃ§a"), alpha = 0.3) +
  geom_ribbon(data = limiares, aes(x = SE, ymin = lim_1, ymax = lim_2, fill = "Zona de alerta"), alpha = 0.3) +
  geom_ribbon(data = limiares, aes(x = SE, ymin = lim_2, ymax = lim_3, fill = "Zona epidÃªmica"), alpha = 0.3) +

  geom_line(data = atual, aes(x = SE, y = inc, color = "Incidencia atual"), size = 1.2) +

  # Nowcasting
  geom_ribbon(data = nowcast, aes(x = SE, ymin = ic_low, ymax = ic_up),
            fill = "gray50", alpha = 0.3) +
geom_line(data = nowcast, aes(x = SE, y = inc_corrigida, color = "Incidencia corrigida"),
          linewidth = 1.2)+


  labs(
    x = "Semana EpidemiolÃ³gica",
    y = "IncidÃªncia por 100 mil hab.",
    fill = "Faixas de risco",
    color = "",
    caption = caption_text
  ) +
  scale_fill_manual(
  values = c(
      "Zona de controle" = "green",
      "Zona de seguranÃ§a" = "yellow",
      "Zona de alerta" = "orange",
      "Zona epidÃªmica" = "red"
  ),
   breaks = c("Zona de controle", "Zona de seguranÃ§a", "Zona de alerta", "Zona epidÃªmica")
)+
  scale_color_manual(values = c("Incidencia atual" = "blue", "Incidencia corrigida" = "red")) +
  theme_minimal() +
  theme(legend.position = "right")
```

```{r Texto Diagrama de controle, echo=FALSE, results='asis',results='asis'}
gerar_bloco_diagrama_controle_recente <- function(atual, limiares, nowcast, ano, regiao = "RegiÃ£o Leste") {
  library(dplyr)
  library(glue)
  
  # Determinar Ãºltimas 4 semanas disponÃ­veis no nowcast
  semanas_recentes <- tail(base::sort(nowcast$SE), 4)

  # Classificar zona apenas para semanas recentes
  zonas_recentes <- nowcast %>%
  filter(SE %in% semanas_recentes) %>%
  left_join(limiares, by = "SE") %>%
  mutate(
    zona = case_when(
      inc_corrigida <= media ~ "zona de controle",
      inc_corrigida <= lim_1 ~ "zona de seguranÃ§a",
      inc_corrigida <= lim_2 ~ "zona de alerta",
      TRUE                  ~ "zona epidÃªmica"
    )
  )


  # Zona predominante nas Ãºltimas 4 semanas
  zona_predom <- zonas_recentes %>%
    count(zona) %>%
    arrange(desc(n)) %>%
    slice(1) %>%
    dplyr::pull(zona)

 cor_emojis <- c(
  "zona de controle" = "<span style='color:#2ECC71'>&#9679;</span>",     # verde
  "zona de seguranÃ§a" = "<span style='color:#F1C40F'>&#9679;</span>",    # amarelo
  "zona de alerta" = "<span style='color:#E67E22'>&#9679;</span>",       # laranja
  "zona epidÃªmica" = "<span style='color:#E74C3C'>&#9679;</span>"        # vermelho
)


  cor_nomes <- c(
    "zona de controle" = "verde",
    "zona de seguranÃ§a" = "amarelo",
    "zona de alerta" = "laranja",
    "zona epidÃªmica" = "vermelho"
  )

  emoji <- cor_emojis[zona_predom]
  cor_nome <- cor_nomes[zona_predom]

  # TendÃªncia recente do nowcasting
  nowcast <- nowcast %>% arrange(SE)
  delta <- if (base::nrow(nowcast) >= 2) {
    dplyr::last(nowcast$inc_corrigida) - dplyr::lag(nowcast$inc_corrigida, 1) %>% dplyr::last()
  } else {
    0
  }

  tendencia <- case_when(
    delta < -0.5 ~ "declÃ­nio",
    delta > 0.5  ~ "aumento",
    TRUE         ~ "estabilidade"
  )

  # Texto final
  glue::glue(
"
 Nas Ãºltimas 4 semanas epidemiolÃ³gicas analisadas, os nÃ­veis de incidÃªncia de SRAG na {regiao} mantiveram-se predominantemente na **{emoji} {zona_predom}**.  
 
A tendÃªncia da curva corrigida por atraso de notificaÃ§Ã£o indica um padrÃ£o de **{tendencia}**, sugerindo que o cenÃ¡rio atual tende a se **manter ou evoluir em curto prazo** nessa mesma zona de risco.  
 
Com base na situaÃ§Ã£o recente, recomenda-se a ativaÃ§Ã£o do **nÃ­vel {emoji} _{cor_nome}_** do plano de contingÃªncia, com foco nas seguintes aÃ§Ãµes:

* ReforÃ§o da vigilÃ¢ncia e encerramento oportuno de casos;  
* AvaliaÃ§Ã£o da capacidade de resposta hospitalar e laboratorial;  
* ComunicaÃ§Ã£o contÃ­nua com equipes locais e populaÃ§Ã£o em risco.
"
  )
}

bloco_recentes <- gerar_bloco_diagrama_controle_recente(atual, limiares, nowcast, ano = ano_ref)
bloco_recentes


```


## Diagrama de controle por RA

```{r Diagrama de controle por RA, fig.width=14, fig.height=10,fig.cap = paste0("Figura 14 â€“ Diagrama de controle de SRAG por semana epidmeiolÃ³gica e RegiÃ£o Administrativa, RegiÃ£o Leste -", ano_ref, ".")}

nome_ra_formatado <- function(nome) {
  nome <- tolower(nome)
  case_when(
    nome == "paranoa" ~ "ParanoÃ¡",
    nome == "sao sebastiao" ~ "SÃ£o SebastiÃ£o",
    nome == "itapoa" ~ "ItapoÃ£",
    nome == "jardim botanico" ~ "Jardim BotÃ¢nico",
    TRUE ~ tools::toTitleCase(nome)  # capitaliza o resto
  )
}

# Preparar base com incidÃªncia (como antes)
df_ra <- srag %>%
  left_join(pop, by = c("ano", "ID_MN_RESI_pad")) %>%
  filter(!is.na(populacao)) %>%
  mutate(incidencia = 100000 / populacao)

# Anos de histÃ³rico (excluindo anos epidÃªmicos)
anos_hist <- (ano_ref - 10):(ano_ref - 1)
anos_hist <- setdiff(anos_hist, ano_epidemico)

# Limiares por RA
historico_ra <- df_ra %>%
  filter(ano %in% anos_hist) %>%
  group_by(SE, ID_MN_RESI_pad, ano) %>%  # <-- adiciona o ano
  summarise(casos = n(), pop = first(populacao), .groups = "drop") %>%
  mutate(inc = 100000 * casos / pop)


limiares_ra <- historico_ra %>%
  group_by(SE, ID_MN_RESI_pad) %>%
  summarise(
    media = mean(inc),
    sd = sd(inc),
    lim_1 = media + sd,
    lim_2 = media + 2 * sd,
    lim_3 = media + 2 * sd,
    .groups = "drop"
  )


# Dados atuais
atual_ra <- df_ra %>%
  filter(ano == ano_ref) %>%
  group_by(SE, ID_MN_RESI_pad) %>%
  summarise(casos = n(), pop = base::mean(populacao), .groups = "drop") %>%
  mutate(inc = 100000 * casos / pop) %>%
  arrange(ID_MN_RESI_pad, SE) %>%
  group_by(ID_MN_RESI_pad) %>%
  mutate(inc_ma = zoo::rollmean(inc, k = 4, align = "right", fill = NA)) %>%
  ungroup()

# Ãšltimas 5 semanas por RA
ultima_SE <- base::max(atual_ra$SE, na.rm = TRUE)

nowcast_ra <- atual_ra %>%
  filter(SE >= (ultima_SE - 8), SE <= ultima_SE-1) %>%
  mutate(
    inc_corrigida = inc_ma,
    ic_low = inc_corrigida * 0.9,
    ic_up  = inc_corrigida * 1.1
  ) %>%
  drop_na(inc_corrigida)

limiares_ra <- limiares_ra %>%
  mutate(nome_formatado = nome_ra_formatado(ID_MN_RESI_pad))

atual_ra <- atual_ra %>%
  mutate(nome_formatado = nome_ra_formatado(ID_MN_RESI_pad))

nowcast_ra <- nowcast_ra %>%
  mutate(nome_formatado = nome_ra_formatado(ID_MN_RESI_pad))


# GrÃ¡fico facetado por RegiÃ£o Administrativa
ggplot() +
  geom_ribbon(data = limiares_ra, aes(x = SE, ymin = 0, ymax = media, fill = "Zona de controle"), alpha = 0.3) +
  geom_ribbon(data = limiares_ra, aes(x = SE, ymin = media, ymax = lim_1, fill = "Zona de seguranÃ§a"), alpha = 0.3) +
  geom_ribbon(data = limiares_ra, aes(x = SE, ymin = lim_1, ymax = lim_2, fill = "Zona de alerta"), alpha = 0.3) +
  geom_ribbon(data = limiares_ra, aes(x = SE, ymin = lim_2, ymax = lim_3, fill = "Zona epidÃªmica"), alpha = 0.3) +

  geom_line(data = atual_ra, aes(x = SE, y = inc, color = "IncidÃªncia atual"), linewidth = 1) +

  geom_ribbon(data = nowcast_ra, aes(x = SE, ymin = ic_low, ymax = ic_up), fill = "gray50", alpha = 0.3) +
  geom_line(data = nowcast_ra, aes(x = SE, y = inc_corrigida, color = "IncidÃªncia corrigida"), 
            linewidth = 1.1) +

  facet_wrap(~nome_formatado, scales = "free_y") +

  scale_fill_manual(
    values = c(
      "Zona de controle" = "green",
      "Zona de seguranÃ§a" = "yellow",
      "Zona de alerta" = "orange",
      "Zona epidÃªmica" = "red"
    ),
    breaks = c("Zona de controle", "Zona de seguranÃ§a", "Zona de alerta", "Zona epidÃªmica")
  ) +
  scale_color_manual(values = c(
    "IncidÃªncia atual" = "blue",
    "IncidÃªncia corrigida" = "red"
  )) +
  labs(
    x = "Semana EpidemiolÃ³gica",
    y = "IncidÃªncia por 100 mil hab.",
    fill = "Faixas de risco",
    color = "",
    caption = caption_text
  ) +
  theme_minimal() +
  theme(
    legend.position = "right",
    strip.text = element_text(face = "bold", size = 11)
  )




```

```{r Texto diagrama por RA, echo = FALSE,results='asis'}
gerar_tabela_diagrama_ra <- function(atual_ra, limiares_ra, nowcast_ra, ano) {
  library(dplyr)
  
  ra_list <- base::unique(nowcast_ra$ID_MN_RESI_pad)

 cor_emojis <- c(
  "zona de controle" = "<span style='color:#2ECC71'>&#9679;</span>",     # verde
  "zona de seguranÃ§a" = "<span style='color:#F1C40F'>&#9679;</span>",    # amarelo
  "zona de alerta" = "<span style='color:#E67E22'>&#9679;</span>",       # laranja
  "zona epidÃªmica" = "<span style='color:#E74C3C'>&#9679;</span>"        # vermelho
)


  cor_nomes <- c(
    "zona de controle" = "verde",
    "zona de seguranÃ§a" = "amarelo",
    "zona de alerta" = "laranja",
    "zona epidÃªmica" = "vermelho"
  )

  tabela <- lapply(ra_list, function(ra) {
    dados_atual <- atual_ra %>% filter(ID_MN_RESI_pad == ra)
    dados_limiar <- limiares_ra %>% filter(ID_MN_RESI_pad == ra)
    dados_nowcast <- nowcast_ra %>% filter(ID_MN_RESI_pad == ra) %>% arrange(SE)
    
    semanas_finais <- tail(base::sort(dados_nowcast$SE), 4)
    
    zonas_finais <- dados_nowcast %>%
  filter(SE %in% semanas_finais) %>%
  left_join(dados_limiar, by = "SE") %>%
  mutate(
    zona = case_when(
      inc_corrigida <= media ~ "zona de controle",
      inc_corrigida <= lim_1 ~ "zona de seguranÃ§a",
      inc_corrigida <= lim_2 ~ "zona de alerta",
      TRUE                   ~ "zona epidÃªmica"
    )
  )

    
    zona_predom <- zonas_finais %>%
      count(zona) %>%
      arrange(desc(n)) %>%
      slice(1) %>%
      dplyr::pull(zona)
    
    emoji <- cor_emojis[zona_predom]
    cor_nome <- cor_nomes[zona_predom]

    delta <- if (base::nrow(dados_nowcast) >= 2) {
      dplyr::last(dados_nowcast$inc_corrigida) - dplyr::lag(dados_nowcast$inc_corrigida, 1) %>% dplyr::last()
    } else {
      0
    }

    tendencia <- case_when(
      delta < -0.5 ~ "declÃ­nio",
      delta > 0.5  ~ "aumento",
      TRUE         ~ "estabilidade"
    )

    texto <- paste0(
      "Nas Ãºltimas semanas, a incidÃªncia de SRAG manteve-se predominantemente na **", 
      emoji, " ", zona_predom, "**, com tendÃªncia de **", tendencia, "**. ",
      "Recomenda-se ativar o nÃ­vel **", cor_nome, "** do plano de contingÃªncia, com reforÃ§o da vigilÃ¢ncia e atenÃ§Ã£o aos indicadores locais."
    )

    data.frame(
      Zona_de_Risco = paste(emoji, zona_predom),
      RA = ra,
      RecomendaÃ§Ã£o = texto
    )
  })

  do.call(rbind, tabela)
}

tabela_diagrama <- gerar_tabela_diagrama_ra(atual_ra, limiares_ra, nowcast_ra, ano = ano_ref)

# Gera a tabela
knitr::kable(
  tabela_diagrama,
  format = "markdown",
  escape = FALSE,
  align = "l",
  col.names = c("Zona de Risco", "RegiÃ£o Administrativa", "RecomendaÃ§Ã£o")
)

```



# Taxa de transmissibilidade viral

```{r transmissibilidade-por-ra, warning=FALSE, message=FALSE, fig.width=13, fig.height=10, results='asis',fig.cap = paste0("Figura 15 â€“ Taxa de transmissibilidade viral (RT) por semana epidmeiolÃ³gica e RegiÃ£o Administrativa, RegiÃ£o Leste -", ano_ref, ")")}
# Lista com um grÃ¡fico por RA (faceteando os vÃ­rus dentro de cada RA)
# DicionÃ¡rio de nomes corrigidos
nome_ra_formatado <- function(nome) {
  nome <- tolower(nome)
  case_when(
    nome == "paranoa" ~ "ParanoÃ¡",
    nome == "sao sebastiao" ~ "SÃ£o SebastiÃ£o",
    nome == "itapoa" ~ "ItapoÃ£",
    nome == "jardim botanico" ~ "Jardim BotÃ¢nico",
    TRUE ~ tools::toTitleCase(nome)  # capitaliza o resto
  )
}


# 1. Identificar colunas de PCR confirmadas
col_pcr <- base::grep("^PCR_", base::names(srag), value = TRUE)
col_pcr <- base::setdiff(col_pcr, "PCR_RESUL")

# 2. Base longa com vÃ­rus confirmados
srag_long <- srag %>%
  filter(ano == ano_ref)|>
  select(ID_MN_RESI_pad, DT_SIN_PRI, all_of(col_pcr)) %>%
  pivot_longer(cols = all_of(col_pcr), names_to = "virus", values_to = "confirmado") %>%
  filter(confirmado == 1, !is.na(DT_SIN_PRI)) %>%
  mutate(
    semana = epiweek(DT_SIN_PRI),
    ano = year(DT_SIN_PRI),
    virus_traduzido = virus_map[virus]
  )

# 3. IncidÃªncia por semana, vÃ­rus, RA
incidencia <- srag_long %>%
  group_by(ano, semana, ID_MN_RESI_pad, virus_traduzido) %>%
  summarise(casos = n(), .groups = "drop") %>%
  left_join(pop, by = c("ano", "ID_MN_RESI_pad")) %>%
  mutate(incidencia_100k = casos / populacao * 1e5)

# 4. FunÃ§Ã£o para calcular Rt por vÃ­rus/RA
calcular_rt <- function(df) {
  if (base::nrow(df) < 8) base::return(NULL)
  incid <- df %>% arrange(ano, semana) %>% dplyr::pull(casos)

  config <- make_config(list(mean_si = 3.5, std_si = 2.5))

  res <- tryCatch({
    estimate_R(incid, method = "parametric_si", config = config)
  }, error = function(e) NULL)

  if (base::is.null(res)) base::return(NULL)

  data.frame(
    t = res$R$t_end,
    Rt = res$R$`Mean(R)`,
    low = res$R$`Quantile.0.025(R)`,
    high = res$R$`Quantile.0.975(R)`,
    semana = df$semana[res$R$t_end],
    ano = df$ano[res$R$t_end],
    ID_MN_RESI_pad = df$ID_MN_RESI_pad[1],
    virus = df$virus_traduzido[1]
  )
}

# 5. Aplicar por grupo
resultados_rt <- incidencia %>%
  group_split(ID_MN_RESI_pad, virus_traduzido) %>%  # remove 'semana' do split
  map_dfr(calcular_rt)


graficos_ra <- resultados_rt %>%
  split(.$ID_MN_RESI_pad) %>%
  keep(~ nrow(.x) > 0) %>%
  map(~ {
    df_ra <- .x
    ultima_semana <- df_ra %>%
      group_by(virus) %>%
      filter(semana == base::max(semana, na.rm = TRUE)) %>%
      ungroup()

  
# GrÃ¡fico com o nome corrigido
ggplot(df_ra, aes(x = semana, y = Rt)) +
  geom_line(color = "#1f77b4") +
  geom_ribbon(aes(ymin = low, ymax = high), fill = "#aec7e8", alpha = 0.3) +
  geom_hline(yintercept = 1, linetype = "dashed", color = "red") +
  geom_text(
    data = ultima_semana,
    aes(label = sprintf("Rt: %.2f", Rt)),
    vjust = -0.5, hjust = 1, size = 5, color = "black"
  ) +
  facet_wrap(~ virus, scales = "free_y", ncol = 2) +
  labs(
    title = nome_ra_formatado(base::unique(df_ra$ID_MN_RESI_pad)),
    x = "Semana EpidemiolÃ³gica", y = "Rt estimado"
  ) +
  theme_minimal(base_size = 14)
})


# Juntar os grÃ¡ficos em um grid
grid_completo <- wrap_plots(graficos_ra, ncol = 2)

# Exibir ou salvar
grid_completo
```


O cÃ³dig de interpretaÃ§Ã£o do Rt pode ter alguns erros, atente-se a essas interpretaÃ§Ãµes bÃ¡sicas e adeque no boletim:
Se o valor do Rt for < 1 significa que a circulaÃ§Ã£o estÃ¡ com tendÃªncia de queda. Enquanto valores > 1 significa que estÃ¡ em tendÃªncia de aumento e circulaÃ§Ã£o sustentada.
```{r Texto RT, echo=FALSE, results='asis'}

# 1. Interpretar transmissibilidade por RA e vÃ­rus com base no Rt
interpretacao_por_ra_virus <- resultados_rt %>%
  filter(!is.na(Rt)) %>%
  mutate(
    Rt_maior_que_1 = Rt > 1.05,
    Rt_menor_que_1 = Rt < 1
  ) %>%
  group_by(ID_MN_RESI_pad, virus) %>%
  summarise(
    semanas_com_Rt_maior_que_1 = sum(Rt_maior_que_1),
    semanas_com_Rt_menor_que_1 = sum(Rt_menor_que_1),
    total_semanas = n(),
    .groups = "drop"
  ) %>%
  mutate(
    pct_maior = semanas_com_Rt_maior_que_1 / total_semanas * 100,
    pct_menor = semanas_com_Rt_menor_que_1 / total_semanas * 100,
    Interpretacao = case_when(
      pct_maior >= 60 ~ glue(
        "Em {round(pct_maior, 1)}% das semanas analisadas, o Rt foi superior a 1, indicando uma transmissÃ£o sustentada do vÃ­rus. ",
        "Este padrÃ£o sugere uma circulaÃ§Ã£o viral ativa e contÃ­nua ao longo do perÃ­odo."
      ),
      pct_menor >= 80 ~ glue(
        "Em {round(pct_menor, 1)}% das semanas, o Rt permaneceu abaixo de 1, o que indica que a transmissÃ£o esteve consistentemente controlada na regiÃ£o durante o perÃ­odo analisado."
      ),
      pct_maior >= 30 ~ glue(
        "O Rt foi superior a 1 em {round(pct_maior, 1)}% das semanas e inferior a 1 em {round(pct_menor, 1)}%, ",
        "o que sugere uma transmissÃ£o intermitente, com alternÃ¢ncia entre crescimento e controle da circulaÃ§Ã£o viral."
      ),
      pct_maior > 0 ~ glue(
        "O Rt superou 1 em {round(pct_maior, 1)}% das semanas, indicando possÃ­veis surtos pontuais. ",
        "A maior parte do tempo, entretanto, o Rt permaneceu prÃ³ximo ou abaixo de 1, sugerindo um padrÃ£o de controle relativo."
      ),
      TRUE ~ glue(
        "O Rt permaneceu abaixo de 1 em todas as semanas analisadas, evidenciando controle sustentado da transmissÃ£o do vÃ­rus durante o perÃ­odo."
      )
    ),
    `RegiÃ£o Administrativa` = nome_ra_formatado(ID_MN_RESI_pad)
  ) %>%
  select(`RegiÃ£o Administrativa`, VÃ­rus = virus, Interpretacao)


# 5. Imprimir como tabela Markdown
cat("\n\n### Resumo por RegiÃ£o Administrativa â€“ Transmissibilidade por VÃ­rus\n\n")

knitr::kable(interpretacao_por_ra_virus, format = "pandoc", align = "l")
```

