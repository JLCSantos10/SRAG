theme_minimal(base_size = 13) +
theme(
axis.title.y = element_text(color = "black", face = "bold"),
axis.title.y.right = element_text(color = "black", face = "bold"),
axis.text.x = element_text(face = "bold", color = "black"),
axis.title = element_text(face = "bold"),
plot.title = element_text(face = "bold", color = "black")
)
texto_srag
str(srag_filtrado)
# Lista com um gr√°fico por RA (faceteando os v√≠rus dentro de cada RA)
# Dicion√°rio de nomes corrigidos
nome_ra_formatado <- function(nome) {
nome <- tolower(nome)
case_when(
nome == "paranoa" ~ "Parano√°",
nome == "sao sebastiao" ~ "S√£o Sebasti√£o",
nome == "itapoa" ~ "Itapo√£",
nome == "jardim botanico" ~ "Jardim Bot√¢nico",
TRUE ~ tools::toTitleCase(nome)  # capitaliza o resto
)
}
# 1. Identificar colunas de PCR confirmadas
col_pcr <- grep("^PCR_", names(srag), value = TRUE)
col_pcr <- setdiff(col_pcr, "PCR_RESUL")
# 2. Base longa com v√≠rus confirmados
srag_long <- srag %>%
filter(ano == ano_ref)|>
select(ID_MN_RESI_pad, DT_SIN_PRI, all_of(col_pcr)) %>%
pivot_longer(cols = all_of(col_pcr), names_to = "virus", values_to = "confirmado") %>%
filter(confirmado == 1, !is.na(DT_SIN_PRI)) %>%
mutate(
semana = epiweek(DT_SIN_PRI),
ano = year(DT_SIN_PRI),
virus_traduzido = virus_map[virus]
)
# 3. Incid√™ncia por semana, v√≠rus, RA
incidencia <- srag_long %>%
group_by(ano, semana, ID_MN_RESI_pad, virus_traduzido) %>%
summarise(casos = n(), .groups = "drop") %>%
left_join(pop, by = c("ano", "ID_MN_RESI_pad")) %>%
mutate(incidencia_100k = casos / populacao * 1e5)
# 4. Fun√ß√£o para calcular Rt por v√≠rus/RA
calcular_rt <- function(df) {
if (nrow(df) < 8) return(NULL)
incid <- df %>% arrange(ano, semana) %>% pull(casos)
config <- make_config(list(mean_si = 3.5, std_si = 2.5))
res <- tryCatch({
estimate_R(incid, method = "parametric_si", config = config)
}, error = function(e) NULL)
if (is.null(res)) return(NULL)
data.frame(
t = res$R$t_end,
Rt = res$R$`Mean(R)`,
low = res$R$`Quantile.0.025(R)`,
high = res$R$`Quantile.0.975(R)`,
semana = df$semana[res$R$t_end],
ano = df$ano[res$R$t_end],
ID_MN_RESI_pad = df$ID_MN_RESI_pad[1],
virus = df$virus_traduzido[1]
)
}
# 5. Aplicar por grupo
resultados_rt <- incidencia %>%
group_split(ID_MN_RESI_pad, virus_traduzido) %>%
map_dfr(calcular_rt)
graficos_ra <- resultados_rt %>%
split(.$ID_MN_RESI_pad) %>%
map(~ {
df_ra <- .x
ultima_semana <- df_ra %>%
group_by(virus) %>%
filter(semana == max(semana, na.rm = TRUE)) %>%
ungroup()
# Gr√°fico com o nome corrigido
ggplot(df_ra, aes(x = semana, y = Rt)) +
geom_line(color = "#1f77b4") +
geom_ribbon(aes(ymin = low, ymax = high), fill = "#aec7e8", alpha = 0.3) +
geom_hline(yintercept = 1, linetype = "dashed", color = "red") +
geom_text(
data = ultima_semana,
aes(label = sprintf("Rt: %.2f", Rt)),
vjust = -0.5, hjust = 1, size = 3, color = "black"
) +
facet_wrap(~ virus, scales = "free_y", ncol = 2) +
labs(
title = nome_ra_formatado(unique(df_ra$ID_MN_RESI_pad)),
x = "Semana Epidemiol√≥gica", y = "Rt estimado"
) +
theme_minimal(base_size = 16)
})
# Juntar os gr√°ficos em um grid
grid_completo <- wrap_plots(graficos_ra, ncol = 2)
# Exibir ou salvar
grid_completo
################################################################# Interpreta√ß√£o #################################################################
# 1. Interpretar transmissibilidade por RA e v√≠rus com base no Rt
interpretacao_por_ra_virus <- resultados_rt %>%
filter(!is.na(Rt)) %>%
mutate(Rt_maior_que_1 = Rt > 1.05,
Rt_menor_que_1 = Rt < 1) %>%
group_by(ID_MN_RESI_pad, virus) %>%
summarise(
semanas_com_Rt_maior_que_1 = sum(Rt_maior_que_1),
semanas_com_Rt_menor_que_1 = sum(Rt_menor_que_1),
total_semanas = n(),
.groups = "drop"
) %>%
mutate(
pct_maior = semanas_com_Rt_maior_que_1 / total_semanas * 100,
pct_menor = semanas_com_Rt_menor_que_1 / total_semanas * 100
)
Interpretacao = case_when(
pct_maior >= 60 ~ glue(
"Em {round(pct_maior, 1)}% das semanas analisadas, o Rt foi superior a 1, indicando uma transmiss√£o sustentada do v√≠rus. ",
"Este padr√£o sugere uma circula√ß√£o viral ativa e cont√≠nua ao longo do per√≠odo."
),
pct_menor >= 80 ~ glue(
"Em {round(pct_menor, 1)}% das semanas, o Rt permaneceu abaixo de 1, o que indica que a transmiss√£o esteve consistentemente controlada na regi√£o durante o per√≠odo analisado."
),
pct_maior >= 30 ~ glue(
"O Rt foi superior a 1 em {round(pct_maior, 1)}% das semanas e inferior a 1 em {round(pct_menor, 1)}%, ",
"o que sugere uma transmiss√£o intermitente, com altern√¢ncia entre crescimento e controle da circula√ß√£o viral."
),
pct_maior > 0 ~ glue(
"O Rt superou 1 em {round(pct_maior, 1)}% das semanas, indicando poss√≠veis surtos pontuais. ",
"A maior parte do tempo, entretanto, o Rt permaneceu pr√≥ximo ou abaixo de 1, sugerindo um padr√£o de controle relativo."
),
TRUE ~ glue(
"O Rt permaneceu abaixo de 1 em todas as semanas analisadas, evidenciando controle sustentado da transmiss√£o do v√≠rus durante o per√≠odo."
)
),
# 1. Interpretar transmissibilidade por RA e v√≠rus com base no Rt
interpretacao_por_ra_virus <- resultados_rt %>%
filter(!is.na(Rt)) %>%
mutate(Rt_maior_que_1 = Rt > 1.05,
Rt_menor_que_1 = Rt < 1) %>%
group_by(ID_MN_RESI_pad, virus) %>%
summarise(
semanas_com_Rt_maior_que_1 = sum(Rt_maior_que_1),
semanas_com_Rt_menor_que_1 = sum(Rt_menor_que_1),
total_semanas = n(),
.groups = "drop"
) %>%
mutate(
pct_maior = semanas_com_Rt_maior_que_1 / total_semanas * 100,
pct_menor = semanas_com_Rt_menor_que_1 / total_semanas * 100
)
Interpretacao = case_when(
pct_maior >= 60 ~ glue(
"Em {round(pct_maior, 1)}% das semanas analisadas, o Rt foi superior a 1, indicando uma transmiss√£o sustentada do v√≠rus. ",
"Este padr√£o sugere uma circula√ß√£o viral ativa e cont√≠nua ao longo do per√≠odo."
),
pct_menor >= 80 ~ glue(
"Em {round(pct_menor, 1)}% das semanas, o Rt permaneceu abaixo de 1, o que indica que a transmiss√£o esteve consistentemente controlada na regi√£o durante o per√≠odo analisado."
),
pct_maior >= 30 ~ glue(
"O Rt foi superior a 1 em {round(pct_maior, 1)}% das semanas e inferior a 1 em {round(pct_menor, 1)}%, ",
"o que sugere uma transmiss√£o intermitente, com altern√¢ncia entre crescimento e controle da circula√ß√£o viral."
),
pct_maior > 0 ~ glue(
"O Rt superou 1 em {round(pct_maior, 1)}% das semanas, indicando poss√≠veis surtos pontuais. ",
"A maior parte do tempo, entretanto, o Rt permaneceu pr√≥ximo ou abaixo de 1, sugerindo um padr√£o de controle relativo."
),
TRUE ~ glue(
"O Rt permaneceu abaixo de 1 em todas as semanas analisadas, evidenciando controle sustentado da transmiss√£o do v√≠rus durante o per√≠odo."
)
)
Interpretacao = case_when(
pct_maior >= 60 ~ glue(
"Em {round(pct_maior, 1)}% das semanas analisadas, o Rt foi superior a 1, indicando uma transmiss√£o sustentada do v√≠rus. ",
"Este padr√£o sugere uma circula√ß√£o viral ativa e cont√≠nua ao longo do per√≠odo."
),
pct_menor >= 80 ~ glue(
"Em {round(pct_menor, 1)}% das semanas, o Rt permaneceu abaixo de 1, o que indica que a transmiss√£o esteve consistentemente controlada na regi√£o durante o per√≠odo analisado."
),
pct_maior >= 30 ~ glue(
"O Rt foi superior a 1 em {round(pct_maior, 1)}% das semanas e inferior a 1 em {round(pct_menor, 1)}%, ",
"o que sugere uma transmiss√£o intermitente, com altern√¢ncia entre crescimento e controle da circula√ß√£o viral."
),
pct_maior > 0 ~ glue(
"O Rt superou 1 em {round(pct_maior, 1)}% das semanas, indicando poss√≠veis surtos pontuais. ",
"A maior parte do tempo, entretanto, o Rt permaneceu pr√≥ximo ou abaixo de 1, sugerindo um padr√£o de controle relativo."
),
TRUE ~ glue(
"O Rt permaneceu abaixo de 1 em todas as semanas analisadas, evidenciando controle sustentado da transmiss√£o do v√≠rus durante o per√≠odo."
)
)
Interpretacao = case_when(
pct_maior >= 60 ~ glue(
"Em {round(pct_maior, 1)}% das semanas analisadas, o Rt foi superior a 1, indicando uma transmiss√£o sustentada do v√≠rus. ",
"Este padr√£o sugere uma circula√ß√£o viral ativa e cont√≠nua ao longo do per√≠odo."
),
pct_menor >= 80 ~ glue(
"Em {round(pct_menor, 1)}% das semanas, o Rt permaneceu abaixo de 1, o que indica que a transmiss√£o esteve consistentemente controlada na regi√£o durante o per√≠odo analisado."
),
pct_maior >= 30 ~ glue(
"O Rt foi superior a 1 em {round(pct_maior, 1)}% das semanas e inferior a 1 em {round(pct_menor, 1)}%, ",
"o que sugere uma transmiss√£o intermitente, com altern√¢ncia entre crescimento e controle da circula√ß√£o viral."
),
pct_maior > 0 ~ glue(
"O Rt superou 1 em {round(pct_maior, 1)}% das semanas, indicando poss√≠veis surtos pontuais. ",
"A maior parte do tempo, entretanto, o Rt permaneceu pr√≥ximo ou abaixo de 1, sugerindo um padr√£o de controle relativo."
),
TRUE ~ glue(
"O Rt permaneceu abaixo de 1 em todas as semanas analisadas, evidenciando controle sustentado da transmiss√£o do v√≠rus durante o per√≠odo."
)
),
Interpretacao = case_when(
pct_maior >= 60 ~ glue(
"Em {round(pct_maior, 1)}% das semanas analisadas, o Rt foi superior a 1, indicando uma transmiss√£o sustentada do v√≠rus. ",
"Este padr√£o sugere uma circula√ß√£o viral ativa e cont√≠nua ao longo do per√≠odo."
),
pct_menor >= 80 ~ glue(
"Em {round(pct_menor, 1)}% das semanas, o Rt permaneceu abaixo de 1, o que indica que a transmiss√£o esteve consistentemente controlada na regi√£o durante o per√≠odo analisado."
),
pct_maior >= 30 ~ glue(
"O Rt foi superior a 1 em {round(pct_maior, 1)}% das semanas e inferior a 1 em {round(pct_menor, 1)}%, ",
"o que sugere uma transmiss√£o intermitente, com altern√¢ncia entre crescimento e controle da circula√ß√£o viral."
),
pct_maior > 0 ~ glue(
"O Rt superou 1 em {round(pct_maior, 1)}% das semanas, indicando poss√≠veis surtos pontuais. ",
"A maior parte do tempo, entretanto, o Rt permaneceu pr√≥ximo ou abaixo de 1, sugerindo um padr√£o de controle relativo."
),
TRUE ~ glue(
"O Rt permaneceu abaixo de 1 em todas as semanas analisadas, evidenciando controle sustentado da transmiss√£o do v√≠rus durante o per√≠odo."
),
`Regi√£o Administrativa` = nome_ra_formatado(ID_MN_RESI_pad)
) %>%
select(`Regi√£o Administrativa`, V√≠rus = virus, Interpretacao)
# 1. Interpretar transmissibilidade por RA e v√≠rus com base no Rt
interpretacao_por_ra_virus <- resultados_rt %>%
filter(!is.na(Rt)) %>%
mutate(Rt_maior_que_1 = Rt > 1.05,
Rt_menor_que_1 = Rt < 1) %>%
group_by(ID_MN_RESI_pad, virus) %>%
summarise(
semanas_com_Rt_maior_que_1 = sum(Rt_maior_que_1),
semanas_com_Rt_menor_que_1 = sum(Rt_menor_que_1),
total_semanas = n(),
.groups = "drop"
) %>%
mutate(
pct_maior = semanas_com_Rt_maior_que_1 / total_semanas * 100,
pct_menor = semanas_com_Rt_menor_que_1 / total_semanas * 100
)
Interpretacao = case_when(
pct_maior >= 60 ~ glue(
"Em {round(pct_maior, 1)}% das semanas analisadas, o Rt foi superior a 1, indicando uma transmiss√£o sustentada do v√≠rus. ",
"Este padr√£o sugere uma circula√ß√£o viral ativa e cont√≠nua ao longo do per√≠odo."
),
pct_menor >= 80 ~ glue(
"Em {round(pct_menor, 1)}% das semanas, o Rt permaneceu abaixo de 1, o que indica que a transmiss√£o esteve consistentemente controlada na regi√£o durante o per√≠odo analisado."
),
pct_maior >= 30 ~ glue(
"O Rt foi superior a 1 em {round(pct_maior, 1)}% das semanas e inferior a 1 em {round(pct_menor, 1)}%, ",
"o que sugere uma transmiss√£o intermitente, com altern√¢ncia entre crescimento e controle da circula√ß√£o viral."
),
pct_maior > 0 ~ glue(
"O Rt superou 1 em {round(pct_maior, 1)}% das semanas, indicando poss√≠veis surtos pontuais. ",
"A maior parte do tempo, entretanto, o Rt permaneceu pr√≥ximo ou abaixo de 1, sugerindo um padr√£o de controle relativo."
),
TRUE ~ glue(
"O Rt permaneceu abaixo de 1 em todas as semanas analisadas, evidenciando controle sustentado da transmiss√£o do v√≠rus durante o per√≠odo."
),
`Regi√£o Administrativa` = nome_ra_formatado(ID_MN_RESI_pad)
) %>%
select(`Regi√£o Administrativa`, V√≠rus = virus, Interpretacao)
Interpretacao = case_when(
pct_maior >= 60 ~ glue(
"Em {round(pct_maior, 1)}% das semanas analisadas, o Rt foi superior a 1, indicando uma transmiss√£o sustentada do v√≠rus. ",
"Este padr√£o sugere uma circula√ß√£o viral ativa e cont√≠nua ao longo do per√≠odo."
),
pct_menor >= 80 ~ glue(
"Em {round(pct_menor, 1)}% das semanas, o Rt permaneceu abaixo de 1, o que indica que a transmiss√£o esteve consistentemente controlada na regi√£o durante o per√≠odo analisado."
),
pct_maior >= 30 ~ glue(
"O Rt foi superior a 1 em {round(pct_maior, 1)}% das semanas e inferior a 1 em {round(pct_menor, 1)}%, ",
"o que sugere uma transmiss√£o intermitente, com altern√¢ncia entre crescimento e controle da circula√ß√£o viral."
),
pct_maior > 0 ~ glue(
"O Rt superou 1 em {round(pct_maior, 1)}% das semanas, indicando poss√≠veis surtos pontuais. ",
"A maior parte do tempo, entretanto, o Rt permaneceu pr√≥ximo ou abaixo de 1, sugerindo um padr√£o de controle relativo."
),
TRUE ~ glue(
"O Rt permaneceu abaixo de 1 em todas as semanas analisadas, evidenciando controle sustentado da transmiss√£o do v√≠rus durante o per√≠odo."
),
)
# 1. Interpretar transmissibilidade por RA e v√≠rus com base no Rt
interpretacao_por_ra_virus <- resultados_rt %>%
filter(!is.na(Rt)) %>%
mutate(Rt_maior_que_1 = Rt > 1.05,
Rt_menor_que_1 = Rt < 1) %>%
group_by(ID_MN_RESI_pad, virus) %>%
summarise(
semanas_com_Rt_maior_que_1 = sum(Rt_maior_que_1),
semanas_com_Rt_menor_que_1 = sum(Rt_menor_que_1),
total_semanas = n(),
.groups = "drop"
) %>%
mutate(
pct_maior = semanas_com_Rt_maior_que_1 / total_semanas * 100,
pct_menor = semanas_com_Rt_menor_que_1 / total_semanas * 100
)
Interpretacao = case_when(
pct_maior >= 60 ~ glue(
"Em {round(pct_maior, 1)}% das semanas analisadas, o Rt foi superior a 1, indicando uma transmiss√£o sustentada do v√≠rus. ",
"Este padr√£o sugere uma circula√ß√£o viral ativa e cont√≠nua ao longo do per√≠odo."
),
pct_menor >= 80 ~ glue(
"Em {round(pct_menor, 1)}% das semanas, o Rt permaneceu abaixo de 1, o que indica que a transmiss√£o esteve consistentemente controlada na regi√£o durante o per√≠odo analisado."
),
pct_maior >= 30 ~ glue(
"O Rt foi superior a 1 em {round(pct_maior, 1)}% das semanas e inferior a 1 em {round(pct_menor, 1)}%, ",
"o que sugere uma transmiss√£o intermitente, com altern√¢ncia entre crescimento e controle da circula√ß√£o viral."
),
pct_maior > 0 ~ glue(
"O Rt superou 1 em {round(pct_maior, 1)}% das semanas, indicando poss√≠veis surtos pontuais. ",
"A maior parte do tempo, entretanto, o Rt permaneceu pr√≥ximo ou abaixo de 1, sugerindo um padr√£o de controle relativo."
),
TRUE ~ glue(
"O Rt permaneceu abaixo de 1 em todas as semanas analisadas, evidenciando controle sustentado da transmiss√£o do v√≠rus durante o per√≠odo."
),
)
# 1. Interpretar transmissibilidade por RA e v√≠rus com base no Rt
interpretacao_por_ra_virus <- resultados_rt %>%
filter(!is.na(Rt)) %>%
mutate(
Rt_maior_que_1 = Rt > 1.05,
Rt_menor_que_1 = Rt < 1
) %>%
group_by(ID_MN_RESI_pad, virus) %>%
summarise(
semanas_com_Rt_maior_que_1 = sum(Rt_maior_que_1),
semanas_com_Rt_menor_que_1 = sum(Rt_menor_que_1),
total_semanas = n(),
.groups = "drop"
) %>%
mutate(
pct_maior = semanas_com_Rt_maior_que_1 / total_semanas * 100,
pct_menor = semanas_com_Rt_menor_que_1 / total_semanas * 100,
Interpretacao = case_when(
pct_maior >= 60 ~ glue(
"Em {round(pct_maior, 1)}% das semanas analisadas, o Rt foi superior a 1, indicando uma transmiss√£o sustentada do v√≠rus. ",
"Este padr√£o sugere uma circula√ß√£o viral ativa e cont√≠nua ao longo do per√≠odo."
),
pct_menor >= 80 ~ glue(
"Em {round(pct_menor, 1)}% das semanas, o Rt permaneceu abaixo de 1, o que indica que a transmiss√£o esteve consistentemente controlada na regi√£o durante o per√≠odo analisado."
),
pct_maior >= 30 ~ glue(
"O Rt foi superior a 1 em {round(pct_maior, 1)}% das semanas e inferior a 1 em {round(pct_menor, 1)}%, ",
"o que sugere uma transmiss√£o intermitente, com altern√¢ncia entre crescimento e controle da circula√ß√£o viral."
),
pct_maior > 0 ~ glue(
"O Rt superou 1 em {round(pct_maior, 1)}% das semanas, indicando poss√≠veis surtos pontuais. ",
"A maior parte do tempo, entretanto, o Rt permaneceu pr√≥ximo ou abaixo de 1, sugerindo um padr√£o de controle relativo."
),
TRUE ~ glue(
"O Rt permaneceu abaixo de 1 em todas as semanas analisadas, evidenciando controle sustentado da transmiss√£o do v√≠rus durante o per√≠odo."
)
),
`Regi√£o Administrativa` = nome_ra_formatado(ID_MN_RESI_pad)
) %>%
select(`Regi√£o Administrativa`, V√≠rus = virus, Interpretacao)
# 5. Imprimir como tabela Markdown
cat("\n\n### Resumo por Regi√£o Administrativa ‚Äì Transmissibilidade por V√≠rus\n\n")
knitr::kable(interpretacao_por_ra_virus, format = "pandoc", align = "l")
# Filtro do ano de interesse
srag_filtrado <- srag %>% filter(ano == ano_ref)
# Total de notifica√ß√µes
total_notificacoes <- nrow(srag_filtrado)
# Casos por semana
casos_semanal <- srag_filtrado %>%
group_by(SE) %>%
summarise(casos = n(), .groups = "drop")
# M√©dia e desvio padr√£o
media_casos <- mean(casos_semanal$casos, na.rm = TRUE)
dp_casos <- sd(casos_semanal$casos, na.rm = TRUE)
# Total de √≥bitos
total_obitos <- sum(srag_filtrado$OBITOSRAG == "Sim", na.rm = TRUE)
# Taxa de letalidade (%)
taxa_letalidade <- (total_obitos / total_notificacoes) * 100
# Exibir resumo
tibble::tibble(
`Total de notifica√ß√µes` = total_notificacoes,
`M√©dia semanal de casos` = round(media_casos, 1),
`Desvio padr√£o semanal` = round(dp_casos, 1),
`Total de √≥bitos` = total_obitos,
`Taxa de letalidade (%)` = round(taxa_letalidade, 1)
) %>%
knitr::kable(caption = paste("Resumo da Situa√ß√£o Epidemiol√≥gica ‚Äì", ano_ref))
texto_srag <- gerar_texto_resumo_srag(
ano = ano_ref,
total_notificacoes = total_notificacoes,
media_semanal = media_casos,
dp_semanal = dp_casos,
total_obitos = total_obitos,
taxa_letalidade = taxa_letalidade
)
options(encoding = "UTF-8")
Sys.setlocale("LC_ALL", "Portuguese_Brazil.1252")  # Para Windows
dir.create("BOLETIM_SRAG_files/figure-docx", recursive = TRUE, showWarnings = FALSE)
# Lista de pacotes CRAN
cran_packages <- c(
"tidyverse", "lubridate", "plotly", "forecast", "EpiEstim", "DT", "officer",
"rvg", "scales", "readxl", "purrr", "mem", "zoo", "stringi", "stringr","readxl","flextable","rmarkdown","slider","yaml","patchwork"
)
# Instala apenas os pacotes que ainda n√£o est√£o instalados
to_install_cran <- cran_packages[!(cran_packages %in% installed.packages()[, "Package"])]
if (length(to_install_cran) > 0) {
install.packages(to_install_cran)
}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
library(lubridate)
library(plotly)
library(forecast)
library(EpiEstim)
library(DT)
library(officer)
library(rvg)
library(scales)
library(readxl)
library(purrr)
library(patchwork)
library(zoo)
library(stringi)
library(stringr)
library(readxl)
library(rmarkdown)
library(flextable)
library(slider)
library(yaml)
library(glue)
# üî† Fun√ß√£o para padronizar nomes (min√∫sculo, sem acento, sem espa√ßos)
padronizar_nomes <- function(x) {
x %>%
str_to_lower() %>%
stri_trans_general("Latin-ASCII") %>%
str_trim()
}
# Define o diret√≥rio onde est√£o os arquivos
diretorio <- "//sivitais/sivitais/SRAG/Bancos/"
# Lista arquivos .xlsx que come√ßam com "Casos_SRAG"
arquivos <- list.files(path = diretorio, pattern = "^Casos_SRAG.*\\.xlsx$", full.names = TRUE)
# Seleciona o mais recente pelo nome (assumindo que o nome cont√©m a data)
arquivo_mais_recente <- arquivos[which.max(file.info(arquivos)$mtime)]
# Carrega o arquivo mais recente e aplica as transforma√ß√µes
srag <- read_excel(arquivo_mais_recente) %>%
mutate(
ID_MN_RESI_pad = tolower(str_trim(ID_MN_RESI)),
ano = year(DT_SIN_PRI),
SE = as.integer(SE)
) %>%
filter(res_RS == "Leste", ID_MN_RESI_pad != "brasilia")
# Calcular incid√™ncia por semana epidemiol√≥gica
srag_inc <- srag %>%
left_join(pop, by = c("ano", "ID_MN_RESI_pad")) %>%
filter(!is.na(populacao), ano == ano_ref) %>%
group_by(SE, ID_MN_RESI_pad) %>%
summarise(
casos = n(),
pop = first(populacao),  # Popula√ß√£o daquele munic√≠pio no ano
.groups = "drop"
) %>%
group_by(SE) %>%
summarise(
casos = sum(casos),
pop = sum(pop),
.groups = "drop"
) %>%
mutate(inc = 100000 * casos / pop)
# Ordenar o eixo X corretamente (opcional)
srag_inc$SE <- factor(srag_inc$SE, levels = sort(unique(srag_inc$SE)))
# Gr√°fico de colunas
ggplot(srag_inc, aes(x = SE)) +
geom_col(aes(y = casos), fill = "#1f77b4", width = 0.8) +  # colunas de casos
geom_line(aes(y = inc * max(casos) / max(inc)),  # linha de incid√™ncia reescalada
color = "red", size = 1.2, group = 1) +
scale_y_continuous(
name = "N√∫mero de casos",
sec.axis = sec_axis(~ . * max(srag_inc$inc) / max(srag_inc$casos),
name = "Incid√™ncia por 100 mil hab.")
) +
labs(
x = "Semana Epidemiol√≥gica",
) +
theme_minimal(base_size = 13) +
theme(
axis.title.y = element_text(color = "black", face = "bold"),
axis.title.y.right = element_text(color = "black", face = "bold"),
axis.text.x = element_text(face = "bold", color = "black"),
axis.title = element_text(face = "bold"),
plot.title = element_text(face = "bold", color = "black")
)
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
library(ggplot2)
library(scales)
library(glue)
library(foreign)
library(readxl)
library(sf)
library(ggspatial)
library(knitr)
library(stringi)
library(writexl)
library(patchwork)
library(grid)
library(stringr)
library(flextable)
library(yaml)
